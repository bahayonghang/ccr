name: Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v å¼€å¤´çš„ tag (å¦‚ v2.4.2)

# ğŸ” æƒé™é…ç½® - ä¿®å¤ "Resource not accessible by integration" é”™è¯¯
permissions:
  contents: write  # éœ€è¦å†™å…¥æƒé™ä»¥åˆ›å»º release

env:
  CARGO_TERM_COLOR: always
  PROJECT_NAME: ccr

jobs:
  # ğŸ—ï¸ å¤šå¹³å°æ„å»ºå¹¶å‘å¸ƒ
  build-and-release:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux GNU (ä¸»æµå‘è¡Œç‰ˆ)
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
            
          # Windows (ä¸»æµæ¡Œé¢ç³»ç»Ÿ)
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip
            
          # macOS Apple Silicon (Mç³»åˆ—èŠ¯ç‰‡)
          - target: aarch64-apple-darwin
            os: macos-latest
            archive: tar.gz

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ matrix.target }}-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }} --all-features
        shell: bash

      - name: Prepare release assets (Unix)
        if: matrix.archive == 'tar.gz'
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.version }}-${{ matrix.target }}.tar.gz ${{ env.PROJECT_NAME }}
          shasum -a 256 ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.version }}-${{ matrix.target }}.tar.gz > ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.version }}-${{ matrix.target }}.tar.gz.sha256
          mv ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.version }}-${{ matrix.target }}.tar.gz* ../../../
        shell: bash

      - name: Prepare release assets (Windows)
        if: matrix.archive == 'zip'
        run: |
          cd target/${{ matrix.target }}/release
          7z a ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.version }}-${{ matrix.target }}.zip ${{ env.PROJECT_NAME }}.exe
          sha256sum ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.version }}-${{ matrix.target }}.zip > ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.version }}-${{ matrix.target }}.zip.sha256
          mv ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.version }}-${{ matrix.target }}.zip* ../../../
        shell: bash

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.version }}-${{ matrix.target }}.${{ matrix.archive }}
            ${{ env.PROJECT_NAME }}-${{ steps.get_version.outputs.version }}-${{ matrix.target }}.${{ matrix.archive }}.sha256
          body: |
            ## CCR ${{ steps.get_version.outputs.version }}
            
            ### ğŸ“¥ ä¸‹è½½é“¾æ¥
            
            é€‰æ‹©é€‚åˆä½ ç³»ç»Ÿçš„ç‰ˆæœ¬ï¼š
            
            - **Linux x86_64 (GNU)**ï¼šé€‚ç”¨äºå¤§å¤šæ•° Linux å‘è¡Œç‰ˆï¼ˆUbuntu/Debian/Fedora/Arch ç­‰ï¼‰
            - **Windows x86_64**ï¼šé€‚ç”¨äº Windows 10/11 64ä½ç³»ç»Ÿ
            - **macOS Apple Silicon (ARM64)**ï¼šé€‚ç”¨äº M1/M2/M3/M4 èŠ¯ç‰‡çš„ Mac
            
            ### ğŸ“‹ æ›´æ–°æ—¥å¿—
            
            è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
            
            ### ğŸš€ å¿«é€Ÿå®‰è£…
            
            **Linux/macOS:**
            ```bash
            # ä¸‹è½½å¹¶å®‰è£… (æ›¿æ¢ä¸ºä½ çš„å¹³å°å¯¹åº”çš„æ–‡ä»¶)
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ccr-${{ steps.get_version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz | tar xz
            sudo mv ccr /usr/local/bin/
            
            # éªŒè¯å®‰è£…
            ccr --version
            ```
            
            **Windows:**
            ```powershell
            # ä¸‹è½½ zip æ–‡ä»¶åè§£å‹åˆ° PATH è·¯å¾„
            # éªŒè¯å®‰è£…
            ccr.exe --version
            ```
            
            **ä½¿ç”¨ Cargo å®‰è£…:**
            ```bash
            cargo install --git https://github.com/${{ github.repository }} --tag ${{ github.ref_name }}
            ```
            
            ### ğŸ”’ æ ¡éªŒå’ŒéªŒè¯
            
            æ‰€æœ‰æ–‡ä»¶éƒ½æä¾›äº† SHA256 æ ¡éªŒå’Œï¼Œè¯·éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ï¼š
            
            ```bash
            # Linux/macOS
            sha256sum -c ccr-${{ steps.get_version.outputs.version }}-<target>.tar.gz.sha256
            
            # Windows (PowerShell)
            Get-FileHash ccr-${{ steps.get_version.outputs.version }}-<target>.zip -Algorithm SHA256
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ğŸ–¥ï¸ Tauri æ¡Œé¢åº”ç”¨æ„å»º
  build-tauri:
    name: Build Tauri ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-22.04
          - platform: windows
            os: windows-latest
          - platform: macos
            os: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        working-directory: ccr-ui/frontend
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: ccr-ui/frontend
          tagName: ${{ github.ref_name }}
          releaseName: 'CCR ${{ github.ref_name }}'
          releaseBody: 'See the release notes for details.'
          releaseDraft: false
          prerelease: false

  # ğŸ“¢ å‘å¸ƒåæ±‡æ€»
  post-release:
    name: Post Release Summary
    needs: [build-and-release, build-tauri]
    runs-on: ubuntu-latest
    steps:
      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## âœ… Release ${{ steps.get_version.outputs.version }} æ„å»ºå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ CLI äº§ç‰©ï¼ˆ3ä¸ªä¸»æµå¹³å°ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å¹³å° | æ–‡ä»¶ | æ ¡éªŒå’Œ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ Linux | \`ccr-${{ steps.get_version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz\` | âœ“ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸªŸ Windows | \`ccr-${{ steps.get_version.outputs.version }}-x86_64-pc-windows-msvc.zip\` | âœ“ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ macOS ARM | \`ccr-${{ steps.get_version.outputs.version }}-aarch64-apple-darwin.tar.gz\` | âœ“ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ–¥ï¸ æ¡Œé¢åº”ç”¨ (Tauri)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å¹³å° | æ ¼å¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ Linux | AppImage, deb |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸªŸ Windows | msi, exe |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ macOS | dmg, app |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“¥ ä¸‹è½½ Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
