# åç«¯æ¶æ„è®¾è®¡

CCR UI çš„åç«¯æ˜¯ä¸€ä¸ªåŸºäº Rust å’Œ Axum 0.8 æ„å»ºçš„é«˜æ€§èƒ½ Web æœåŠ¡ã€‚

> **ç‰ˆæœ¬**: v3.16.2  
> **æœ€åæ›´æ–°**: 2025-12-28  
> **æ¡†æ¶**: Axum 0.8.6  
> **æ¶æ„æ¨¡å¼**: åˆ†å±‚æ¶æ„ï¼ˆ6 å±‚ï¼‰

## ğŸ¯ è®¾è®¡ç›®æ ‡

åç«¯æ¶æ„çš„ä¸»è¦è®¾è®¡ç›®æ ‡ï¼š

- **é«˜æ€§èƒ½**ï¼šåˆ©ç”¨ Rust çš„é›¶æˆæœ¬æŠ½è±¡å’Œ Axum çš„å¼‚æ­¥ç‰¹æ€§
- **å®‰å…¨æ€§**ï¼šå†…å­˜å®‰å…¨ã€ç±»å‹å®‰å…¨ï¼Œé˜²æ­¢å¸¸è§çš„å®‰å…¨æ¼æ´
- **å¯é æ€§**ï¼šé”™è¯¯å¤„ç†å®Œå–„ï¼Œç³»ç»Ÿç¨³å®šæ€§é«˜
- **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- **æ˜“ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„ä»£ç ç»“æ„å’Œå®Œå–„çš„æ–‡æ¡£
- **é«˜å¹¶å‘**ï¼šæ”¯æŒå¤§é‡å¹¶å‘è¯·æ±‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### åˆ†å±‚æ¶æ„ï¼ˆv3.15.0ï¼‰

CCR UI Backend é‡‡ç”¨ä¸¥æ ¼çš„ 6 å±‚æ¶æ„ï¼Œå®ç°äº†å…³æ³¨ç‚¹åˆ†ç¦»å’Œä¾èµ–ç®¡ç†ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Routes Layer (è·¯ç”±å±‚)                                 â”‚
â”‚  - 25+ è·¯ç”±æ¨¡å—ï¼ŒæŒ‰åŠŸèƒ½ä¸¥æ ¼åˆ†ç±»                          â”‚
â”‚  - HTTP è·¯ç”±å®šä¹‰ã€ä¸­é—´ä»¶é…ç½®                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Layer (API å¤„ç†å±‚)                                â”‚
â”‚  - handlers/ ç›®å½•ï¼š16+ å¤„ç†å™¨æ–‡ä»¶                       â”‚
â”‚  - HTTP è¯·æ±‚å¤„ç†ã€å‚æ•°éªŒè¯ã€å“åº”æ„å»º                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Services Layer (æœåŠ¡å±‚)                               â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘ç¼–æ’ã€äº‹åŠ¡ç®¡ç†                               â”‚
â”‚  - è·¨å¹³å°è½¬æ¢ã€å‘½ä»¤æ‰§è¡Œã€ç­¾åˆ°æœåŠ¡                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Managers Layer (ç®¡ç†å±‚)                               â”‚
â”‚  - æ•°æ®è®¿é—®ã€æ–‡ä»¶ I/Oã€æŒä¹…åŒ–æ“ä½œ                        â”‚
â”‚  - config/: 5 ä¸ªå¹³å°é…ç½®ç®¡ç†å™¨                          â”‚
â”‚  - checkin/: 8 ä¸ªç­¾åˆ°ç®¡ç†å™¨                            â”‚
â”‚  - å…¶ä»–: markdown, plugins, ui_state                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cache Layer (ç¼“å­˜å±‚) - v3.15.0+                       â”‚
â”‚  - å…¨å±€è®¾ç½®ç¼“å­˜ (30s TTL)                              â”‚
â”‚  - å‡å°‘ 80% æ–‡ä»¶ I/Oï¼Œæ€§èƒ½æå‡ 50-100x                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Models Layer (æ¨¡å‹å±‚)                                 â”‚
â”‚  - æ•°æ®ç»“æ„å®šä¹‰ã€åºåˆ—åŒ–/ååºåˆ—åŒ–                         â”‚
â”‚  - API æ¨¡å‹ã€å¹³å°æ¨¡å‹ã€ç­¾åˆ°æ¨¡å‹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Core Layer (æ ¸å¿ƒå±‚)                                   â”‚
â”‚  - åŸºç¡€è®¾æ–½ï¼šerror, crypto, executor                   â”‚
â”‚  - log_manager, bom_writer                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Utils Layer (å·¥å…·å±‚)                                  â”‚
â”‚  - é€šç”¨å·¥å…·å‡½æ•°ã€é…ç½®è¯»å–                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾èµ–è§„åˆ™**ï¼š
- âœ… **ä¸¥æ ¼å•å‘ä¾èµ–**ï¼šåªèƒ½å‘ä¸‹ä¾èµ–ï¼Œä¸èƒ½åå‘ä¾èµ–
- âœ… **æ— å¾ªç¯ä¾èµ–**ï¼šä»»ä½•ä¸¤å±‚ä¹‹é—´ä¸èƒ½å½¢æˆå¾ªç¯
- âœ… **è·¨å±‚è°ƒç”¨ç¦æ­¢**ï¼šä¸èƒ½è·¨å±‚ç›´æ¥è°ƒç”¨ï¼ˆå¦‚ API ç›´æ¥è°ƒç”¨ Managersï¼‰

### ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚"
        Frontend["Vue 3 + TypeScript<br/>ğŸ“± http://localhost:3000"]
    end
    
    subgraph "åç«¯å±‚ - Axum Server :38081"
        subgraph "å…¥å£ & ä¸­é—´ä»¶"
            Server["ğŸš€ Axum HTTP Server"]
            Middleware["ğŸ”§ Middleware Stack<br/>â”œâ”€ CORS<br/>â”œâ”€ Compression<br/>â”œâ”€ Tracing<br/>â”œâ”€ Request ID<br/>â””â”€ Error Handling"]
            Router["ğŸ›£ï¸ Router<br/>25 è·¯ç”±æ¨¡å—"]
        end
        
        subgraph "Handlers (API å±‚)"
            HConfig["ğŸ“‹ Config Handler"]
            HCommand["âš¡ Command Handler"]
            HMCP["ğŸ”Œ MCP Handler"]
            HAgent["ğŸ¤– Agent Handler"]
            HCheckin["ğŸ“… Checkin Handler"]
            HStats["ğŸ“Š Stats Handler"]
            HBudget["ğŸ’° Budget Handler"]
            HSystem["ğŸ’» System Handler"]
        end
        
        subgraph "Services Layer"
            SCommand["å‘½ä»¤æœåŠ¡"]
            SConverter["è½¬æ¢æœåŠ¡"]
            SCheckin["ç­¾åˆ°æœåŠ¡"]
            SWebSocket["WebSocket æœåŠ¡"]
            SWAFBypass["WAF ç»•è¿‡æœåŠ¡"]
        end
        
        subgraph "Managers Layer"
            MConfig["é…ç½®ç®¡ç†å™¨ç»„<br/>claude/codex/gemini/qwen"]
            MCheckin["ç­¾åˆ°ç®¡ç†å™¨ç»„<br/>account/balance/provider/record"]
            MMarkdown["Markdown ç®¡ç†å™¨"]
            MPlugins["æ’ä»¶ç®¡ç†å™¨"]
        end
        
        subgraph "Cache Layer (v3.15.0+)"
            Cache["å…¨å±€è®¾ç½®ç¼“å­˜<br/>30s TTL"]
        end
        
        subgraph "Core & Models"
            CoreError["é”™è¯¯å¤„ç†"]
            CoreExecutor["å‘½ä»¤æ‰§è¡Œå™¨"]
            CoreLog["æ—¥å¿—ç®¡ç†"]
            Models["æ•°æ®æ¨¡å‹"]
        end
    end
    
    subgraph "æ–‡ä»¶ç³»ç»Ÿ"
        FSSettings["~/.claude/settings.json"]
        FSClaudeJSON["~/.claude.json"]
        FSAgents["~/.claude/agents/"]
        FSPlugins["~/.claude/plugins/"]
        FSCheckin["~/.ccr-ui/checkin.db"]
    end
    
    Frontend ==>|"HTTP/JSON API"| Server
    Server --> Middleware
    Middleware --> Router
    
    Router -.->|route| HConfig
    Router -.->|route| HCommand
    Router -.->|route| HMCP
    Router -.->|route| HAgent
    Router -.->|route| HCheckin
    Router -.->|route| HStats
    Router -.->|route| HBudget
    Router -.->|route| HSystem
    
    HConfig --> SCommand
    HCheckin --> SCheckin
    
    SCommand --> MConfig
    SCheckin --> MCheckin
    
    MConfig --> Cache
    Cache --> FSSettings
    MConfig --> FSClaudeJSON
    MMarkdown --> FSAgents
    MPlugins --> FSPlugins
    MCheckin --> FSCheckin
    
    SCommand --> CoreExecutor
    
    style Frontend fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style Server fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style Cache fill:#fff9c4,stroke:#f9a825,stroke-width:2px
```

## ğŸ“¦ ä¸»è¦æ¨¡å—

### 1. Routes Layer (è·¯ç”±å±‚)

ä½äº `src/routes/`ï¼Œå®šä¹‰æ‰€æœ‰ HTTP è·¯ç”±ã€‚

**25+ è·¯ç”±æ¨¡å—**ï¼š
```
routes/
â”œâ”€â”€ mod.rs                      # è·¯ç”±ç»„è£…ä¸ä¸­é—´ä»¶
â”œâ”€â”€ agents_routes.rs            # Agents ç®¡ç†è·¯ç”±
â”œâ”€â”€ budget_routes.rs            # é¢„ç®—ç®¡ç†è·¯ç”±
â”œâ”€â”€ builtin_prompts_routes.rs  # å†…ç½®æç¤ºè¯è·¯ç”±
â”œâ”€â”€ checkin_routes.rs           # ç­¾åˆ°ç®¡ç†è·¯ç”±
â”œâ”€â”€ codex_routes.rs             # Codex å¹³å°è·¯ç”±
â”œâ”€â”€ command_routes.rs           # å‘½ä»¤æ‰§è¡Œè·¯ç”±
â”œâ”€â”€ config_routes.rs            # é…ç½®ç®¡ç†è·¯ç”±
â”œâ”€â”€ converter_routes.rs         # é…ç½®è½¬æ¢è·¯ç”±
â”œâ”€â”€ gemini_routes.rs            # Gemini å¹³å°è·¯ç”±
â”œâ”€â”€ mcp_routes.rs               # MCP ç®¡ç†è·¯ç”±
â”œâ”€â”€ other_routes.rs             # å…¶ä»–è·¯ç”±
â”œâ”€â”€ platform_routes.rs          # å¹³å°ç®¡ç†è·¯ç”±
â”œâ”€â”€ plugins_routes.rs           # æ’ä»¶ç®¡ç†è·¯ç”±
â”œâ”€â”€ pricing_routes.rs           # å®šä»·ç®¡ç†è·¯ç”±
â”œâ”€â”€ prompts_routes.rs           # æç¤ºè¯ç®¡ç†è·¯ç”±
â”œâ”€â”€ provider_health_routes.rs  # æä¾›å•†å¥åº·æ£€æŸ¥è·¯ç”±
â”œâ”€â”€ qwen_routes.rs              # Qwen å¹³å°è·¯ç”±
â”œâ”€â”€ sessions_routes.rs          # ä¼šè¯ç®¡ç†è·¯ç”±
â”œâ”€â”€ skills_routes.rs            # æŠ€èƒ½ç®¡ç†è·¯ç”±
â”œâ”€â”€ slash_commands_routes.rs   # æ–œæ å‘½ä»¤è·¯ç”±
â”œâ”€â”€ stats_routes.rs             # ç»Ÿè®¡è·¯ç”±
â”œâ”€â”€ sync_routes.rs              # åŒæ­¥è·¯ç”±
â”œâ”€â”€ system_routes.rs            # ç³»ç»Ÿä¿¡æ¯è·¯ç”±
â”œâ”€â”€ ui_state_routes.rs          # UI çŠ¶æ€è·¯ç”±
â”œâ”€â”€ usage_routes.rs             # ä½¿ç”¨è®°å½•è·¯ç”±
â””â”€â”€ version_routes.rs           # ç‰ˆæœ¬ç®¡ç†è·¯ç”±
```

**ä¸­é—´ä»¶æ ˆ**ï¼ˆåœ¨ `routes/mod.rs::apply_middleware()`ï¼‰ï¼š
1. **Request ID**: ç”Ÿæˆå’Œä¼ æ’­å”¯ä¸€è¯·æ±‚ ID
2. **Tracing**: ç»“æ„åŒ–æ—¥å¿—è®°å½•
3. **CORS**: è·¨åŸŸèµ„æºå…±äº«ï¼ˆå…è®¸æ‰€æœ‰æ¥æºï¼‰
4. **Compression**: è‡ªåŠ¨å‹ç¼©å“åº”ï¼ˆgzip/br/zstdï¼‰

### 2. API Layer (API å¤„ç†å±‚)

ä½äº `src/api/handlers/`ï¼Œå¤„ç† HTTP è¯·æ±‚ã€‚

**16+ å¤„ç†å™¨æ–‡ä»¶**ï¼š
```
api/handlers/
â”œâ”€â”€ mod.rs                  # Handler å¯¼å‡º
â”œâ”€â”€ agents.rs               # Agents CRUD
â”œâ”€â”€ budget.rs               # é¢„ç®—æŸ¥è¯¢
â”œâ”€â”€ builtin_prompts.rs      # å†…ç½®æç¤ºè¯
â”œâ”€â”€ checkin.rs              # ç­¾åˆ°åŠŸèƒ½ï¼ˆé‡è¦ï¼ï¼‰
â”œâ”€â”€ command.rs              # å‘½ä»¤æ‰§è¡Œ
â”œâ”€â”€ config.rs               # é…ç½®ç®¡ç†
â”œâ”€â”€ converter.rs            # æ ¼å¼è½¬æ¢
â”œâ”€â”€ logs.rs                 # æ—¥å¿—æŸ¥è¯¢
â”œâ”€â”€ mcp.rs                  # MCP æœåŠ¡å™¨
â”œâ”€â”€ mcp_presets.rs          # MCP é¢„è®¾
â”œâ”€â”€ platform.rs             # å¹³å°ç®¡ç†
â”œâ”€â”€ platforms/              # å¹³å°ä¸“å±å¤„ç†å™¨
â”‚   â”œâ”€â”€ codex.rs
â”‚   â”œâ”€â”€ gemini.rs
â”‚   â”œâ”€â”€ qwen.rs
â”‚   â””â”€â”€ iflow.rs
â”œâ”€â”€ plugins.rs              # æ’ä»¶ç®¡ç†
â”œâ”€â”€ pricing.rs              # å®šä»·ä¿¡æ¯
â”œâ”€â”€ prompts.rs              # æç¤ºè¯ç®¡ç†
â”œâ”€â”€ response.rs             # å“åº”æ„å»º
â”œâ”€â”€ skills.rs               # æŠ€èƒ½ç®¡ç†
â”œâ”€â”€ slash_commands.rs       # æ–œæ å‘½ä»¤
â”œâ”€â”€ stats.rs                # ç»Ÿè®¡æ•°æ®
â”œâ”€â”€ sync.rs                 # WebDAV åŒæ­¥
â”œâ”€â”€ system.rs               # ç³»ç»Ÿä¿¡æ¯
â”œâ”€â”€ ui_state.rs             # UI çŠ¶æ€
â”œâ”€â”€ usage.rs                # ä½¿ç”¨è®°å½•
â””â”€â”€ version.rs              # ç‰ˆæœ¬ä¿¡æ¯
```

### 3. Services Layer (æœåŠ¡å±‚)

ä½äº `src/services/`ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ã€‚

**7 ä¸ªæœåŠ¡æ¨¡å—**ï¼š
```
services/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ checkin_service.rs      # ç­¾åˆ°ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ commands.rs             # å‘½ä»¤æœåŠ¡
â”œâ”€â”€ converter_service.rs    # é…ç½®è½¬æ¢æœåŠ¡
â”œâ”€â”€ log_persistence.rs      # æ—¥å¿—æŒä¹…åŒ–
â”œâ”€â”€ waf_bypass.rs           # WAF ç»•è¿‡ï¼ˆç­¾åˆ°ä¸“ç”¨ï¼‰
â””â”€â”€ websocket.rs            # WebSocket æœåŠ¡
```

**å…³é”®æœåŠ¡**ï¼š
- `checkin_service`: ç®¡ç†ç­¾åˆ°æµç¨‹ã€è´¦å·ã€æä¾›å•†
- `converter_service`: è·¨å¹³å°é…ç½®æ ¼å¼è½¬æ¢
- `waf_bypass`: ä½¿ç”¨ chromiumoxide ç»•è¿‡ WAF é™åˆ¶

### 4. Managers Layer (ç®¡ç†å±‚)

ä½äº `src/managers/`ï¼Œè´Ÿè´£æ•°æ®è®¿é—®å’ŒæŒä¹…åŒ–ã€‚

**Config ç®¡ç†å™¨ç»„** (`managers/config/`):
```
config/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ platform_manager.rs     # å¹³å°æŠ½è±¡æ¥å£
â”œâ”€â”€ claude_manager.rs       # Claude Code é…ç½®
â”œâ”€â”€ codex_manager.rs        # Codex é…ç½®
â”œâ”€â”€ gemini_manager.rs       # Gemini CLI é…ç½®
â””â”€â”€ qwen_manager.rs         # Qwen é…ç½®
```

**Checkin ç®¡ç†å™¨ç»„** (`managers/checkin/`) - **æ–°å¢ v3.7+**:
```
checkin/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ account_manager.rs      # è´¦å·ç®¡ç†
â”œâ”€â”€ balance_manager.rs      # ä½™é¢æŸ¥è¯¢
â”œâ”€â”€ provider_manager.rs     # æä¾›å•†ç®¡ç†
â”œâ”€â”€ record_manager.rs       # ç­¾åˆ°è®°å½•
â”œâ”€â”€ waf_cookie_manager.rs   # Cookie ç®¡ç†
â”œâ”€â”€ builtin_providers.rs    # å†…ç½®æä¾›å•†é…ç½®
â””â”€â”€ export_manager.rs       # å¯¼å…¥å¯¼å‡º
```

**å…¶ä»–ç®¡ç†å™¨**ï¼š
```
managers/
â”œâ”€â”€ markdown_manager.rs     # Markdown æ–‡ä»¶ CRUD
â”œâ”€â”€ plugins_manager.rs      # æ’ä»¶é…ç½®ç®¡ç†
â”œâ”€â”€ settings_manager.rs     # è®¾ç½®ç®¡ç†ï¼ˆå·²åºŸå¼ƒï¼‰
â””â”€â”€ ui_state_manager.rs     # UI çŠ¶æ€æŒä¹…åŒ–
```

### 5. Cache Layer (ç¼“å­˜å±‚) - **v3.15.0+**

ä½äº `src/cache/`ï¼Œå…¨å±€ç¼“å­˜æœºåˆ¶ã€‚

**ç‰¹æ€§**ï¼š
- **TTL**: 30 ç§’è‡ªåŠ¨è¿‡æœŸ
- **æ€§èƒ½**: å‡å°‘ 80% æ–‡ä»¶ I/Oï¼Œæå‡ 50-100x
- **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ `Arc<RwLock<T>>`
- **è‡ªåŠ¨åˆ·æ–°**: è¿‡æœŸæ—¶è‡ªåŠ¨é‡æ–°åŠ è½½

**ç¼“å­˜çš„æ•°æ®**ï¼š
- `~/.claude/settings.json` çš„å…¨å±€é…ç½®
- MCP æœåŠ¡å™¨åˆ—è¡¨
- Agents åˆ—è¡¨
- æ’ä»¶é…ç½®

### 6. Models Layer (æ¨¡å‹å±‚)

ä½äº `src/models/`ï¼Œå®šä¹‰æ•°æ®ç»“æ„ã€‚

```
models/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ api.rs                  # é€šç”¨ API æ¨¡å‹
â”œâ”€â”€ converter.rs            # è½¬æ¢å™¨æ¨¡å‹
â”œâ”€â”€ monitoring.rs           # ç›‘æ§æ¨¡å‹
â”œâ”€â”€ ui_state.rs             # UI çŠ¶æ€æ¨¡å‹
â”œâ”€â”€ usage.rs                # ä½¿ç”¨è®°å½•æ¨¡å‹
â”œâ”€â”€ checkin/                # ç­¾åˆ°æ¨¡å‹
â”‚   â”œâ”€â”€ account.rs
â”‚   â”œâ”€â”€ balance.rs
â”‚   â”œâ”€â”€ provider.rs
â”‚   â”œâ”€â”€ record.rs
â”‚   â”œâ”€â”€ dashboard.rs
â”‚   â””â”€â”€ export.rs
â””â”€â”€ platforms/              # å¹³å°ç‰¹å®šæ¨¡å‹
    â”œâ”€â”€ codex.rs
    â”œâ”€â”€ gemini.rs
    â””â”€â”€ qwen.rs
```

### 7. Core Layer (æ ¸å¿ƒå±‚)

ä½äº `src/core/`ï¼ŒåŸºç¡€è®¾æ–½ã€‚

```
core/
â”œâ”€â”€ mod.rs
â”œâ”€â”€ error.rs                # ç»Ÿä¸€é”™è¯¯ç±»å‹
â”œâ”€â”€ executor.rs             # CCR å‘½ä»¤æ‰§è¡Œå™¨
â”œâ”€â”€ log_manager.rs          # æ—¥å¿—è½®è½¬ä¸æ¸…ç†
â”œâ”€â”€ crypto.rs               # AES-256-GCM åŠ å¯†ï¼ˆç­¾åˆ°ç”¨ï¼‰
â””â”€â”€ bom_writer.rs           # UTF-8 BOM å†™å…¥ï¼ˆWindows å…¼å®¹ï¼‰
```

**å…³é”®æ¨¡å—**ï¼š
- `error.rs`: å®šä¹‰ `AppError` æšä¸¾ï¼Œç»Ÿä¸€é”™è¯¯å¤„ç†
- `executor.rs`: é€šè¿‡å­è¿›ç¨‹è°ƒç”¨ CCR CLI
- `crypto.rs`: API Key åŠ å¯†å­˜å‚¨ï¼ˆç­¾åˆ°åŠŸèƒ½ä¸“ç”¨ï¼‰
- `log_manager.rs`: æ—¥å¿—æ–‡ä»¶æ—¥è½®è½¬ã€è‡ªåŠ¨æ¸…ç†

### 8. Utils Layer (å·¥å…·å±‚)

ä½äº `src/utils/`ï¼Œé€šç”¨å·¥å…·å‡½æ•°ã€‚

```
utils/
â”œâ”€â”€ mod.rs
â””â”€â”€ config_reader.rs        # é€šç”¨é…ç½®è¯»å–å·¥å…·
```

## ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### ç­¾åˆ°ç®¡ç†ç³»ç»Ÿ (v3.7+)

**æ¶æ„**ï¼š
```
Handlers â†’ CheckinService â†’ CheckinManagers â†’ Models â†’ SQLite
```

**åŠŸèƒ½**ï¼š
1. **æä¾›å•†ç®¡ç†**: å†…ç½® + è‡ªå®šä¹‰æä¾›å•†
2. **è´¦å·ç®¡ç†**: å¤šæä¾›å•†ã€å¤šè´¦å·æ”¯æŒ
3. **è‡ªåŠ¨ç­¾åˆ°**: æ‰¹é‡ç­¾åˆ°ã€å®šæ—¶ä»»åŠ¡
4. **ä½™é¢æŸ¥è¯¢**: å®æ—¶æŸ¥è¯¢è´¦å·ä½™é¢
5. **è®°å½•è¿½è¸ª**: ç­¾åˆ°å†å²ã€æˆåŠŸ/å¤±è´¥ç»Ÿè®¡
6. **WAF ç»•è¿‡**: ä½¿ç”¨ Chromium ç»•è¿‡ CloudFlare

**å†…ç½®æä¾›å•†**ï¼š
- AnyRouter (`anyrouter.top`) - éœ€ WAF ç»•è¿‡
- AgentRouter (`agentrouter.org`) - è‡ªåŠ¨ç­¾åˆ°
- CodeRouter (`api.codemirror.codes`) - æ— ç­¾åˆ°

**æ•°æ®å­˜å‚¨**: `~/.ccr-ui/checkin.db` (SQLite)

### WebSocket å®æ—¶é€šä¿¡

**ç”¨é€”**ï¼š
- å®æ—¶æ—¥å¿—æµ
- å‘½ä»¤æ‰§è¡Œè¿›åº¦
- ç³»ç»ŸçŠ¶æ€æ›´æ–°

**ç«¯ç‚¹**: `/ws`

## ğŸ”’ å®‰å…¨ç‰¹æ€§

1. **API Key åŠ å¯†**: ä½¿ç”¨ AES-256-GCM åŠ å¯†å­˜å‚¨
2. **CORS é…ç½®**: å¯é…ç½®çš„è·¨åŸŸç­–ç•¥
3. **Request ID**: è¯·æ±‚è¿½è¸ªå’Œå®¡è®¡
4. **é”™è¯¯éšè—**: ç”Ÿäº§ç¯å¢ƒä¸æš´éœ²æ•æ„Ÿé”™è¯¯
5. **åŸå­æ“ä½œ**: æ–‡ä»¶å†™å…¥ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ + åŸå­é‡å‘½å

## ğŸ“Š æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| **Web æ¡†æ¶** | Axum | 0.8.6 | HTTP æœåŠ¡å™¨å’Œè·¯ç”± |
| **ä¸­é—´ä»¶** | Tower + Tower-HTTP | 0.5/0.6 | CORSã€å‹ç¼©ã€æ—¥å¿— |
| **å¼‚æ­¥è¿è¡Œæ—¶** | Tokio | 1.48.0 | å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ |
| **åºåˆ—åŒ–** | Serde + Serde JSON | 1.0 | JSON/TOML åºåˆ—åŒ– |
| **é…ç½®è§£æ** | TOML | 0.9 | é…ç½®æ–‡ä»¶è§£æ |
| **é”™è¯¯å¤„ç†** | Anyhow/Thiserror | 1.0/2.0 | é”™è¯¯å¤„ç†å’Œä¼ æ’­ |
| **æ—¥å¿—** | Tracing | 0.1 | ç»“æ„åŒ–æ—¥å¿—è®°å½• |
| **CLI è§£æ** | Clap | 4.5 | å‘½ä»¤è¡Œå‚æ•°è§£æ |
| **ç³»ç»Ÿä¿¡æ¯** | Sysinfo | 0.37.2 | ç³»ç»Ÿä¿¡æ¯è·å– |
| **HTTP å®¢æˆ·ç«¯** | Reqwest | 0.12.25 | ç­¾åˆ° API è°ƒç”¨ |
| **åŠ å¯†** | AES-GCM | 0.10 | API Key åŠ å¯† |
| **æµè§ˆå™¨è‡ªåŠ¨åŒ–** | chromiumoxide | 0.8 | WAF ç»•è¿‡ |

## ğŸ“ é¡¹ç›®ç»“æ„

å®Œæ•´çš„ç›®å½•ç»“æ„è¯·å‚è€ƒ [`backend/CLAUDE.md`](../../backend/CLAUDE.md)ã€‚

## ğŸš€ æ„å»ºå’Œéƒ¨ç½²

### å¼€å‘æ¨¡å¼

```bash
cd ccr-ui/backend
cargo run -- --port 38081

# å¯ç”¨è°ƒè¯•æ—¥å¿—
RUST_LOG=debug cargo run
```

### ç”Ÿäº§æ„å»º

```bash
cd ccr-ui/backend
cargo build --release

# äºŒè¿›åˆ¶æ–‡ä»¶: target/release/ccr-ui-backend
./target/release/ccr-ui-backend --port 38081
```

### Docker éƒ¨ç½²

```dockerfile
FROM rust:1.85 as builder
WORKDIR /app
COPY . .
RUN cargo build --release

FROM debian:bookworm-slim
COPY --from=builder /app/target/release/ccr-ui-backend /usr/local/bin/
EXPOSE 38081
CMD ["ccr-ui-backend", "--port", "38081"]
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æŠ€æœ¯æ ˆè¯¦è§£](./tech-stack.md)
- [å¼€å‘æŒ‡å—](./development.md)
- [API æ–‡æ¡£](./api.md)
- [éƒ¨ç½²æŒ‡å—](./deployment.md)
- [é”™è¯¯å¤„ç†](./error-handling.md)
- [Backend CLAUDE.md](../../backend/CLAUDE.md) - æœ€è¯¦ç»†çš„å¼€å‘æ–‡æ¡£