# 签到功能详细指南

> **版本**: v3.7+  
> **最后更新**: 2025-12-28  
> **功能状态**: ✅ 稳定

AI 中转站自动签到功能，支持多提供商、多账号管理，自动签到获取积分/额度。

## 📋 目录

- [功能概述](#功能概述)
- [核心概念](#核心概念)
- [快速开始](#快速开始)
- [提供商管理](#提供商管理)
- [账号管理](#账号管理)
- [签到操作](#签到操作)
- [余额查询](#余额查询)
- [WAF 绕过](#waf-绕过)
- [数据管理](#数据管理)
- [常见问题](#常见问题)

## 🎯 功能概述

CCR UI 的签到功能允许您：

- 📝 **管理多个中转站提供商**（内置 + 自定义）
- 👤 **每个提供商支持多个账号**
- ✅ **一键批量签到**所有启用的账号
- 💰 **查询账号剩余额度**
- 📊 **查看签到历史和统计**
- 🔒 **API Key 加密存储**（AES-256-GCM）
- 🌐 **WAF 绕过**（使用 Chromium 自动化）
- 📦 **导入导出配置**

## 🧩 核心概念

### 提供商 (Provider)

中转站服务提供商的配置信息。

**内置提供商**：
- 🌐 **AnyRouter** - `anyrouter.top`
  - 支持签到: ✅
  - 需要 WAF 绕过: ✅
  - 特点: 需要使用浏览器自动化绕过 CloudFlare

- 🤖 **AgentRouter** - `agentrouter.org`
  - 支持签到: ⚠️ 自动签到
  - 特点: 查询用户信息时自动签到

- 💻 **CodeRouter** - `api.codemirror.codes`
  - 支持签到: ❌
  - 特点: 无签到功能

**自定义提供商**：
您可以添加任何支持标准签到 API 的中转站。

### 账号 (Account)

绑定到提供商的具体账号，包含：
- 账号名称（自定义标识）
- API Key（加密存储）
- 启用状态
- 最后签到时间

### 签到记录 (Record)

每次签到操作的记录，包含：
- 签到时间
- 成功/失败状态
- 返回消息
- 获得的积分/额度

## 🚀 快速开始

### 1. 访问签到管理页面

在 CCR UI 主界面：
1. 点击左侧菜单的 **"签到"**
2. 或直接访问 `http://localhost:3000/checkin`

### 2. 添加第一个提供商

**使用内置提供商**（推荐）：

1. 在签到页面点击 **"添加提供商"** 按钮
2. 选择 **"从内置列表选择"** 标签
3. 浏览内置提供商列表：
   - 🌐 AnyRouter
   - 🤖 AgentRouter
   - 💻 CodeRouter
4. 点击提供商卡片的 **"添加"** 按钮
5. 提供商自动添加到您的配置中

**添加自定义提供商**：

1. 点击 **"添加提供商"** → **"自定义配置"**
2. 填写以下信息：
   ```
   名称: My Provider
   基础 URL: https://example.com
   签到路径: /api/user/sign_in
   余额查询路径: /api/user/self
   用户信息路径: /api/user/self
   认证头: Authorization
   认证前缀: Bearer 
   ```
3. 点击 **"保存"**

### 3. 添加账号

1. 在提供商列表中找到您添加的提供商
2. 点击 **"管理账号"** 或 **"添加账号"**
3. 填写账号信息：
   ```
   账号名称: 主账号
   API Key: sk-xxx... (从中转站获取)
   启用签到: ✅
   ```
4. 点击 **"保存"**

### 4. 执行签到

**批量签到**（推荐）：
1. 点击页面顶部的 **"批量签到"** 按钮
2. 系统自动对所有启用的账号执行签到
3. 查看签到结果统计

**单个账号签到**：
1. 在账号列表中找到目标账号
2. 点击账号卡片上的 **"立即签到"** 按钮
3. 查看签到结果

## 🏪 提供商管理

### 查看提供商列表

在签到主页，您可以看到所有已添加的提供商：

```
┌──────────────────────────────────────┐
│ 🌐 AnyRouter                          │
│ https://anyrouter.top                 │
│ 账号数: 2 | 今日签到: 2/2             │
│ [管理账号] [查看详情] [删除]          │
└──────────────────────────────────────┘
```

### 编辑提供商

1. 点击提供商卡片上的 **"编辑"** 按钮
2. 修改提供商配置
3. 点击 **"保存"** 应用更改

**可编辑的字段**：
- 基础 URL
- 签到路径
- 余额查询路径
- 用户信息路径
- 认证头和前缀

**不可编辑**：
- 提供商 ID（系统生成）
- 创建时间

### 删除提供商

⚠️ **警告**：删除提供商将同时删除该提供商下的所有账号和签到记录！

1. 点击提供商卡片上的 **"删除"** 按钮
2. 在确认对话框中点击 **"确认删除"**

### 启用/禁用提供商

1. 点击提供商卡片上的切换开关
2. 禁用后，该提供商下的所有账号将不参与批量签到

## 👤 账号管理

### 添加账号

1. 进入提供商的账号管理页面
2. 点击 **"添加账号"** 按钮
3. 填写表单：

   | 字段 | 说明 | 示例 |
   |------|------|------|
   | **账号名称** | 自定义标识 | 主账号、测试账号 |
   | **API Key** | 从中转站获取的密钥 | sk-ant-xxx... |
   | **启用签到** | 是否参与自动签到 | ✅ |

4. 点击 **"保存"**

**安全提示**：
- API Key 使用 AES-256-GCM 加密存储
- 存储在 `~/.ccr-ui/checkin.db`
- 只有您的机器可以解密

### 查看账号列表

在提供商详情页，查看该提供商的所有账号：

```
┌────────────────────────────────────────────┐
│ 主账号                                      │
│ API Key: sk-ant-****1234                    │
│ 剩余额度: $10.50 | 最后签到: 2小时前        │
│ 状态: ✅ 已启用                              │
│ [立即签到] [查询余额] [编辑] [删除]         │
└────────────────────────────────────────────┘
```

### 编辑账号

1. 点击账号卡片上的 **"编辑"** 按钮
2. 修改账号信息（除 API Key 外的所有字段）
3. 点击 **"保存"**

**注意**：API Key 一旦保存无法直接查看，只能重新输入替换。

### 删除账号

1. 点击账号卡片上的 **"删除"** 按钮
2. 确认删除操作

**影响**：
- 账号配置被删除
- 该账号的签到记录保留（可选清除）

### 启用/禁用账号

使用账号卡片上的切换开关：
- ✅ **启用**：参与批量签到
- ❌ **禁用**：跳过签到

## ✅ 签到操作

### 批量签到

**触发方式**：
1. 手动：点击 **"批量签到"** 按钮
2. 定时：设置自动签到（计划中功能）

**执行流程**：
```
1. 收集所有启用的账号
2. 按提供商分组
3. 对每个账号：
   a. 检查最后签到时间（避免重复）
   b. 发送签到请求
   c. 记录签到结果
4. 显示统计结果
```

**结果展示**：
```
签到完成！
✅ 成功: 5 个账号
❌ 失败: 1 个账号
⏭️ 跳过: 2 个账号（今日已签到）
```

### 单账号签到

1. 在账号列表找到目标账号
2. 点击 **"立即签到"** 按钮
3. 等待签到完成（通常 1-3 秒）
4. 查看结果：
   - ✅ 成功：显示获得的积分/额度
   - ❌ 失败：显示错误信息

### 签到结果类型

| 状态 | 图标 | 说明 |
|------|------|------|
| **Success** | ✅ | 签到成功，获得奖励 |
| **AlreadyCheckedIn** | ⏭️ | 今日已签到，跳过 |
| **Failed** | ❌ | 签到失败（网络错误、API 错误等） |
| **Skipped** | ⚠️ | 账号已禁用，跳过 |

### 查看签到历史

1. 点击 **"签到记录"** 标签
2. 查看历史记录列表：

   | 时间 | 账号 | 提供商 | 状态 | 消息 |
   |------|------|--------|------|------|
   | 10:30 | 主账号 | AnyRouter | ✅ | 签到成功，获得 1000 积分 |
   | 10:32 | 测试账号 | AnyRouter | ⏭️ | 今日已签到 |
   | 10:35 | 账号 3 | AgentRouter | ❌ | API Key 无效 |

3. 使用过滤器：
   - 按提供商过滤
   - 按状态过滤
   - 按日期范围过滤

## 💰 余额查询

### 查询单个账号余额

1. 在账号列表找到目标账号
2. 点击 **"查询余额"** 按钮
3. 等待查询完成（通常 1-2 秒）
4. 查看余额信息：

   ```
   剩余额度: $10.50
   已用额度: $5.25
   总额度: $15.75
   使用率: 33.33%
   查询时间: 2025-12-28 14:30:00
   ```

### 批量余额查询

1. 在账号管理页面顶部
2. 点击 **"批量查询余额"** 按钮
3. 系统自动查询所有启用账号的余额
4. 更新账号卡片上的余额显示

### 自动余额更新

余额信息会在以下情况自动更新：
- ✅ 签到成功后
- 🔄 手动刷新页面时
- ⏰ 定时刷新（每 5 分钟，可配置）

### 余额显示格式

不同提供商可能有不同的额度单位：

| 提供商 | 单位 | 显示格式 |
|--------|------|----------|
| AnyRouter | 积分 | 10,000 积分 |
| AgentRouter | 美元 | $10.50 |
| CodeRouter | 次数 | 500 次 |

## 🌐 WAF 绕过

某些中转站使用 CloudFlare 等 WAF 保护，需要使用浏览器自动化绕过。

### 什么时候需要 WAF 绕过？

**标识**：
- 提供商配置中 `requires_waf_bypass: true`
- 签到失败，错误信息包含 "403"、"CloudFlare"、"Challenge"

**支持 WAF 绕过的提供商**：
- 🌐 AnyRouter（默认启用）

### 如何工作

1. 系统启动一个无头 Chromium 浏览器
2. 访问目标网站，自动解决 CloudFlare Challenge
3. 获取通过验证的 Cookie
4. 使用 Cookie 发送签到请求

**技术细节**：
- 浏览器引擎: Chromium (chromiumoxide)
- 无头模式: 是
- 自动化框架: Chrome DevTools Protocol (CDP)
- Cookie 存储: 内存（每次签到重新获取）

### 配置代理

WAF 绕过默认使用系统代理设置：

**Windows**:
```cmd
set HTTPS_PROXY=http://127.0.0.1:7890
set HTTP_PROXY=http://127.0.0.1:7890
```

**Linux/macOS**:
```bash
export HTTPS_PROXY=http://127.0.0.1:7890
export HTTP_PROXY=http://127.0.0.1:7890
```

**Socks5 代理**:
```bash
export ALL_PROXY=socks5://127.0.0.1:7890
```

### 故障排除

**问题**: WAF 绕过失败

**可能原因**：
1. Chromium 未安装
   - 解决: 后端首次运行会自动下载
2. 代理配置错误
   - 检查代理是否正常工作
   - 尝试在浏览器中访问目标网站
3. CloudFlare 规则更新
   - 等待后端更新绕过逻辑

**调试模式**：
```bash
# 启动后端时启用调试日志
RUST_LOG=debug cargo run
```

查看日志中的 WAF 绕过过程：
```
[DEBUG] WAF bypass started for anyrouter.top
[DEBUG] Launching Chromium...
[DEBUG] Navigating to https://anyrouter.top
[DEBUG] Waiting for CloudFlare challenge...
[DEBUG] Challenge solved, extracting cookies
[DEBUG] Cookie obtained: cf_clearance=...
[INFO] WAF bypass successful
```

## 📦 数据管理

### 导出配置

**用途**：
- 备份签到配置
- 迁移到其他机器
- 与他人分享提供商配置

**步骤**：
1. 点击 **"导出配置"** 按钮
2. 选择导出选项：
   - ✅ **包含提供商配置**
   - ✅ **包含账号配置**
   - ⚠️ **包含明文 API Key**（不推荐）
   - ❌ **不包含签到记录**（可选）
3. 点击 **"导出"**
4. 保存 JSON 文件

**导出文件格式**：
```json
{
  "version": "1.0",
  "export_time": "2025-12-28T14:30:00Z",
  "providers": [
    {
      "id": "anyrouter",
      "name": "AnyRouter",
      "base_url": "https://anyrouter.top",
      "..."
    }
  ],
  "accounts": [
    {
      "provider_id": "anyrouter",
      "name": "主账号",
      "api_key": "***encrypted***",
      "enabled": true
    }
  ]
}
```

### 导入配置

**用途**：
- 从备份恢复
- 从其他机器迁移
- 导入他人分享的配置

**步骤**：
1. 点击 **"导入配置"** 按钮
2. 选择 JSON 文件
3. 选择冲突处理策略：
   - **跳过** (skip): 跳过已存在的项
   - **覆盖** (overwrite): 覆盖已存在的项
   - **合并** (merge): 保留两者（重命名冲突项）
4. 点击 **"导入"**
5. 查看导入结果

**冲突处理示例**：
```
已存在提供商: AnyRouter
策略: 跳过 → 保持原有配置
策略: 覆盖 → 使用导入的配置
策略: 合并 → 重命名为 "AnyRouter (2)"
```

### 清理数据

**清理签到记录**：
1. 进入 **"设置"** → **"数据管理"**
2. 点击 **"清理签到记录"**
3. 选择清理范围：
   - 7 天前的记录
   - 30 天前的记录
   - 所有记录
4. 确认清理

**重置所有数据**：
⚠️ **危险操作**：将删除所有提供商、账号和记录！

1. 进入 **"设置"** → **"数据管理"**
2. 点击 **"重置所有数据"**
3. 输入确认码: `DELETE ALL`
4. 确认重置

## ❓ 常见问题

### Q1: 签到失败，提示 "API Key 无效"

**原因**：
- API Key 错误或已过期
- 提供商更改了 API 规则

**解决**：
1. 登录中转站网站，检查 API Key 是否有效
2. 复制新的 API Key
3. 在 CCR UI 中编辑账号，更新 API Key

### Q2: 显示 "今日已签到"，但我没有签过

**原因**：
- 中转站可能在其他地方已经签到（网页、手机 App）
- 签到记录时间判断问题

**解决**：
- 正常现象，等待明天再签到
- 如果确认未签到，联系中转站客服

### Q3: WAF 绕过一直失败

**可能原因**：
1. 代理未配置或无法访问目标网站
2. Chromium 未正确安装

**解决步骤**：
1. 检查代理配置：
   ```bash
   echo $HTTPS_PROXY
   curl -v https://anyrouter.top
   ```
2. 重新安装 Chromium：
   删除 `~/.cache/chromiumoxide/`，重启后端
3. 查看后端日志，寻找详细错误

### Q4: 余额查询返回 0 或错误数据

**原因**：
- 提供商 API 响应格式变化
- 余额查询路径错误

**解决**：
1. 检查提供商配置中的 `balance_path`
2. 手动访问该路径，查看返回数据格式
3. 如果格式不匹配，联系开发者更新

### Q5: 批量签到速度很慢

**原因**：
- 网络延迟
- WAF 绕过耗时（启动 Chromium 需要 3-5 秒）

**优化建议**：
1. 使用代理加速网络
2. 对于不需要 WAF 绕过的提供商，配置 `requires_waf_bypass: false`
3. 避免过多账号同时签到（建议分批）

### Q6: 数据存储在哪里？

**位置**：
- SQLite 数据库: `~/.ccr-ui/checkin.db`
- API Key 加密密钥: 存储在系统密钥链或本地文件

**备份建议**：
1. 定期导出配置到 JSON 文件
2. 备份 `~/.ccr-ui/` 整个目录

### Q7: 如何迁移到新机器？

**步骤**：
1. 在旧机器：导出配置（勾选 "包含明文 API Key"）
2. 将 JSON 文件复制到新机器
3. 在新机器：安装 CCR UI，导入配置
4. 验证签到功能正常

**注意**：
- 不勾选明文导出时，API Key 只能在同一机器上解密
- 跨机器迁移必须导出明文 API Key

### Q8: 可以自动定时签到吗？

**当前状态**：计划中功能（v3.8+）

**临时解决方案**：
1. 使用系统定时任务（cron/Task Scheduler）
2. 调用 CCR UI 的签到 API：
   ```bash
   curl -X POST http://localhost:38081/api/checkin/execute
   ```

**Linux crontab 示例**：
```bash
# 每天 8:00 自动签到
0 8 * * * curl -X POST http://localhost:38081/api/checkin/execute
```

**Windows 任务计划程序**：
- 触发器: 每天 08:00
- 操作: 启动程序
  - 程序: `curl`
  - 参数: `-X POST http://localhost:38081/api/checkin/execute`

## 🔗 相关文档

- [功能概览](./features.md) - 所有功能列表
- [后端 API 文档](../reference/backend/api.md) - 签到 API 端点详情
- [后端架构](../reference/backend/architecture.md) - 签到功能技术实现

## 📞 获取帮助

如果您遇到问题：

1. 查看本文档的常见问题部分
2. 查看后端日志: `~/.ccr-ui/logs/backend/`
3. 提交 Issue: [GitHub Issues](https://github.com/bahayonghang/ccr/issues)
4. 加入讨论: [GitHub Discussions](https://github.com/bahayonghang/ccr/discussions)

---

**浮浮酱温馨提示**：签到功能完全在本地运行，您的 API Key 使用 AES-256-GCM 加密存储，安全可靠！(´｡• ᵕ •｡`) ♡
