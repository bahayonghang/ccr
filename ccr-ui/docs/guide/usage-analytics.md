# 使用统计分析 (Usage Analytics)

CCR UI 提供了全面的 Token 使用统计分析功能，帮助您实时追踪跨 AI 平台的 Token 消耗情况，深入了解使用模式和活动趋势。

## 功能概览

使用统计分析功能包括：

- ✅ **多平台支持** - 支持 Claude、Codex、Gemini 三大平台
- ✅ **实时 Token 追踪** - 精确记录输入、输出和缓存读取 Token
- ✅ **时间趋势图表** - SVG 原生绘制的流畅面积图
- ✅ **活动热力图** - GitHub 风格的 365 天活动日历
- ✅ **多维度筛选** - 按时间范围、模型、自定义日期筛选
- ✅ **缓存效率分析** - 实时计算缓存命中率
- ✅ **自动刷新** - 可配置的定时数据刷新
- ✅ **响应式设计** - 完美支持桌面和移动端
- ✅ **深色模式** - 完整的 dark mode 主题支持
- ✅ **液态玻璃设计** - 现代化的 glassmorphism UI

## 访问使用统计页面

### 通过导航菜单

1. 启动 CCR UI
2. 点击左侧导航栏的"使用统计" (Usage)
3. 访问 `http://localhost:5173/usage`

### 通过 Dashboard

1. 在 Dashboard 首页找到"📊 使用统计"卡片
2. 点击"查看详情"按钮

## 界面介绍

### 页面头部

#### 平台选择器
- **位置**: 页面右上角
- **样式**: 靛蓝色渐变边框，悬停发光效果
- **选项**:
  - 🤖 Claude
  - 💻 Codex
  - ✨ Gemini
- **功能**: 切换不同平台的统计数据

#### 刷新按钮
- **位置**: 平台选择器右侧
- **样式**: 绿-青渐变 + 发光效果
- **文字**: "刷新数据" / "加载中..."
- **功能**: 手动刷新最新数据
- **交互**:
  - 悬停放大 10%
  - 点击缩小 5%
  - 加载时图标旋转

### 筛选栏

#### 时间范围选择
- **最近 5 小时** - 查看最近 5 小时的数据
- **今天** - 查看今日数据
- **最近 7 天** - 查看过去 7 天
- **本周** - 查看本周数据（周一至今）
- **本月** - 查看本月数据
- **全部时间** - 查看所有历史数据

#### 自定义日期范围
- **日期选择器**: 选择起始和结束日期
- **清除按钮**: 清除自定义日期范围
- **优先级**: 自定义日期范围会覆盖预设的时间范围

#### 模型筛选
- **全部模型** - 显示所有模型的数据
- **特定模型** - 仅显示选定模型的数据
- **模型列表**: 自动从数据中提取可用模型

#### 自动刷新
- **开关**: 启用/禁用自动刷新
- **间隔选项**:
  - 30秒
  - 60秒
  - 2分钟
  - 5分钟

### 概览卡片

页面显示 4 个关键指标卡片：

#### 📥 输入 Tokens
- **描述**: 用户发送给 AI 的 Token 总数
- **显示格式**: 使用 K/M 简化（如 1.5M = 1,500,000）
- **图标**: 蓝色云朵下载图标
- **样式**: 蓝色渐变背景

#### 📤 输出 Tokens
- **描述**: AI 生成的 Token 总数
- **显示格式**: K/M 简化
- **图标**: 绿色云朵上传图标
- **样式**: 绿色渐变背景

#### 🗄️ 缓存读取
- **描述**: 从缓存读取的 Token 数量
- **显示格式**: K/M 简化
- **图标**: 琥珀色存储图标
- **样式**: 琥珀色渐变背景

#### ⚡ 缓存效率
- **描述**: 缓存命中率百分比
- **计算公式**: `(缓存读取 / (输入 + 缓存读取)) × 100%`
- **显示格式**: 百分比，保留一位小数
- **图标**: 紫色闪电图标
- **样式**: 紫色渐变背景

### Token 使用趋势图表

#### 图表头部
- **标题**: "Token 使用趋势"
- **筛选状态徽章**:
  - 蓝色徽章：显示当前时间范围
  - 紫色徽章：显示选中的模型（非全部时）

#### 图例控制
- **输入** (蓝色) - 切换输入 Token 曲线显示
- **输出** (绿色) - 切换输出 Token 曲线显示
- **缓存** (琥珀色) - 切换缓存读取 Token 曲线显示
- **交互**: 点击切换，激活时有彩色边框和背景

#### 图表区域
- **类型**: 面积图（Area Chart）
- **技术**: 原生 SVG 绘制
- **坐标系统**:
  - X 轴：时间（根据时间范围自动调整格式）
  - Y 轴：Token 数量（自动缩放，10% padding）
- **数据点**: 最多显示 50 个时间点
- **聚合逻辑**:
  - 5小时/今天：按小时聚合
  - 7天/本周：按天聚合
  - 本月/全部：按周聚合

#### 视觉效果
- **渐变填充**: 每条曲线使用对应颜色的渐变
- **网格线**: 半透明虚线网格
- **悬停效果**: 数据点高亮（计划中）
- **空状态**: 显示"所选筛选条件下无可用数据"

### 活动热力图

#### 头部信息
- **标题**: "活动热力图"
- **图例**: "较少" ↔ "较多"
- **样式**: 5 个渐变方块，从灰色到深绿色

#### 热力图网格
- **时间跨度**: 最近 365 天
- **布局**: 按周排列，每周 7 天
- **月份标签**: 顶部显示月份名称
- **星期标签**: 左侧显示周一、周三、周五
- **颜色等级**:
  - Level 0 (无活动): 灰色
  - Level 1 (少量): 浅绿色
  - Level 2 (中等): 中绿色
  - Level 3 (较多): 深绿色
  - Level 4 (大量): 最深绿色

#### 交互功能
- **悬停提示**: 显示日期和 Token 数量
- **提示框**:
  - 日期格式: "Nov 18, 2025"
  - Token 数量: 使用 K/M 简化
  - 绿色圆点指示器

#### 统计摘要
- **活跃天数**: 有 Token 使用的天数总计
- **总 Token 数**: 365 天的 Token 总和

## 功能使用

### 查看不同平台的数据

1. 点击右上角的平台选择器
2. 选择目标平台（Claude/Codex/Gemini）
3. 页面自动加载该平台的数据

### 筛选特定时间范围

#### 使用预设范围
1. 在筛选栏找到时间图标
2. 选择预设范围（最近 5 小时、今天、最近 7 天等）
3. 数据自动更新

#### 使用自定义日期
1. 点击"自定义日期范围"按钮
2. 在弹出的日期选择器中选择起始和结束日期
3. 点击"应用"按钮
4. 要清除自定义范围，点击"清除"按钮

### 筛选特定模型

1. 在筛选栏找到过滤器图标
2. 从下拉列表选择模型
3. 选择"全部模型"查看所有数据

### 启用自动刷新

1. 勾选"自动刷新"复选框
2. 选择刷新间隔（30秒/60秒/2分钟/5分钟）
3. 页面将按选定间隔自动刷新

### 分析趋势图表

1. 观察图表中的曲线走势
2. 使用图例切换显示/隐藏特定类型的 Token
3. 查看 X 轴时间标签了解时间分布
4. 查看 Y 轴数值了解使用量级

### 查看活动热力图

1. 滚动到活动热力图部分
2. 悬停在任意日期方块上查看详情
3. 观察颜色深浅了解活动强度
4. 查看底部摘要了解总体统计

## 数据格式说明

### Token 类型

#### 输入 Token (input_tokens)
- **定义**: 用户发送给 AI 的文本内容
- **包含**: 提示词、上下文、系统消息
- **来源**: API 请求中的 messages 内容

#### 输出 Token (output_tokens)
- **定义**: AI 生成的响应文本
- **包含**: 助手回复、工具调用结果
- **来源**: API 响应中的 content

#### 缓存读取 Token (cache_read_input_tokens)
- **定义**: 从 Prompt Cache 读取的 Token
- **优势**: 读取成本仅为普通输入的 10%
- **适用场景**: 重复使用相同的系统提示或长上下文

### 缓存效率计算

```
缓存效率 = (缓存读取 Token / (输入 Token + 缓存读取 Token)) × 100%
```

**示例**:
- 输入 Token: 1,000
- 缓存读取 Token: 4,000
- 缓存效率: (4,000 / 5,000) × 100% = 80%

**意义**:
- 效率越高，说明缓存使用越充分
- 高缓存效率可显著降低成本

### 时间聚合逻辑

根据时间范围自动选择聚合粒度：

| 时间范围 | 聚合粒度 | X 轴格式 |
|---------|---------|---------|
| 5小时 | 小时 | HH:MM |
| 今天 | 小时 | HH:MM |
| 7天 | 天 | Mon DD |
| 本周 | 天 | Mon DD |
| 本月 | 周 | Mon DD |
| 全部时间 | 周 | Mon DD |

## API 端点

> **注意**: V1 端点 `/api/usage/records` 已被移除。请使用新的 V2 端点：
> - `GET /api/usage/dashboard` - 聚合数据
> - `GET /api/usage/logs` - 分页日志
> - `GET /api/usage/summary`, `/trends`, `/by-model`, `/by-project`, `/heatmap` - 专项统计

### 数据源

#### Claude
- **路径**: `~/.claude/projects/**/*.jsonl`
- **格式**: JSONL (每行一个 JSON 对象)
- **字段**: uuid, timestamp, model, usage

#### Codex
- **路径**: `~/.codex/projects/**/*.jsonl`
- **格式**: 同 Claude

#### Gemini
- **路径**: `~/.gemini/projects/**/*.jsonl`
- **格式**: 同 Claude

## 技术实现

### 前端技术栈

- **框架**: Vue.js 3.5 Composition API
- **类型**: TypeScript 5.7
- **样式**: Tailwind CSS 3.4
- **构建**: Vite 7.1
- **图表**: 原生 SVG（无第三方库）
- **状态**: Ref + Computed
- **路由**: Vue Router 4.4

### 核心组件

#### UsageView.vue
- **路径**: `frontend/src/views/UsageView.vue`
- **职责**: 页面容器、筛选控制、数据获取
- **功能**:
  - 平台切换
  - 时间范围筛选
  - 模型筛选
  - 自动刷新
  - 数据聚合

#### TokenUsageChart.vue
- **路径**: `frontend/src/components/TokenUsageChart.vue`
- **职责**: Token 使用趋势图表
- **功能**:
  - SVG 面积图绘制
  - 数据聚合和缩放
  - 图例交互
  - 筛选状态显示

#### ActivityHeatmap.vue
- **路径**: `frontend/src/components/ActivityHeatmap.vue`
- **职责**: 365 天活动热力图
- **功能**:
  - 热力图网格生成
  - 颜色等级计算
  - 悬停提示
  - 统计摘要

#### DateRangePicker.vue
- **路径**: `frontend/src/components/DateRangePicker.vue`
- **职责**: 自定义日期范围选择器
- **功能**:
  - 日期选择
  - 应用/清除操作
  - 与主筛选栏集成

### 后端技术栈

- **框架**: Axum 0.8 (Rust)
- **异步运行时**: Tokio 1.48
- **序列化**: Serde + serde_json
- **并行处理**: Rayon 1.10
- **缓存**: lazy_static + Arc\<Mutex\<HashMap\>\>
- **文件遍历**: WalkDir 2.5

### 后端优化

#### 1. 智能缓存
```rust
// 60 秒 TTL 缓存
lazy_static! {
    static ref USAGE_CACHE: Arc<Mutex<HashMap<String, CachedUsageData>>> =
        Arc::new(Mutex::new(HashMap::new()));
}

const CACHE_TTL: Duration = Duration::from_secs(60);
```

#### 2. 并行文件处理
```rust
// 多文件并行读取
if jsonl_files.len() > 1 {
    use rayon::prelude::*;
    jsonl_files.par_iter().flat_map(|path| {
        // 并行解析
    }).collect()
}
```

#### 3. 数据验证
- 验证平台参数（claude/codex/gemini）
- 限制最大返回记录数（50,000）
- 跳过无效 JSON 行
- 过滤无效记录（缺少必需字段）

### 数据流

```
Vue Component
    ↓
API Client (Axios)
    ↓
GET /api/usage/dashboard (V2 聚合端点)
    ↓
Axum Handler (usage.rs)
    ↓
检查缓存
    ↓ (缓存未命中)
并行读取 JSONL 文件 (Rayon)
    ↓
解析 JSON (serde_json)
    ↓
验证 & 过滤
    ↓
按时间戳排序
    ↓
聚合统计
    ↓
更新缓存
    ↓
返回 JSON 响应
    ↓
Vue Component 更新
```

## 性能特性

### 前端性能

- **虚拟滚动**: 热力图使用高效的网格布局（无虚拟化，365 天可直接渲染）
- **计算缓存**: 使用 `computed` 缓存聚合结果
- **条件渲染**: `v-if` 避免不必要的组件渲染
- **防抖**: 筛选操作防抖（计划中）
- **懒加载**: 图表数据按需加载

### 后端性能

- **缓存**: 60 秒 TTL，避免重复文件读取
- **并行处理**: 多文件并行读取和解析（2-4x 加速）
- **流式处理**: 逐行解析 JSONL，内存友好
- **早期验证**: 无效数据尽早过滤
- **智能聚合**: 限制最多 50 个数据点

### 内存优化

- **后端**: 最多缓存 50,000 条记录（约 5-10 MB）
- **前端**: 聚合到最多 50 个数据点
- **热力图**: 固定 365 个数据点
- **垃圾回收**: 缓存过期自动清理

## 常见问题

### 为什么图表显示为空？

**可能原因**:
1. 选择的时间范围内没有数据
2. 筛选的模型没有使用记录
3. 平台目录不存在（如 `~/.claude/projects/`）
4. JSONL 文件格式错误

**解决方法**:
1. 扩大时间范围到"全部时间"
2. 选择"全部模型"
3. 检查平台目录是否存在
4. 查看浏览器控制台错误信息

### 为什么数据不更新？

**可能原因**:
1. 后端缓存未过期（60 秒内）
2. 浏览器缓存
3. 后端服务未运行

**解决方法**:
1. 等待 60 秒后点击"刷新数据"
2. 硬刷新浏览器（Ctrl+Shift+R）
3. 检查后端服务状态：`curl http://localhost:8081/health`

### 图表纵坐标为什么不匹配？

这个问题已修复！之前版本的图表坐标系统不统一，导致数据和刻度不匹配。

**修复内容**:
- 统一图表绘制区域坐标系统
- 网格线、Y 轴标签、数据曲线完全对齐
- 添加 10% padding 防止数据触顶
- 所有坐标计算使用相同的基准点

### 如何提高缓存效率？

**建议**:
1. 使用 Prompt Caching 功能
2. 固定系统提示词放在缓存区
3. 重复使用相同的长上下文
4. 查看 Anthropic 缓存最佳实践

**预期效果**:
- 系统提示缓存：效率可达 80-90%
- 长文档分析：效率可达 60-70%
- 一般对话：效率约 20-30%

### 数据是否准确？

是的！数据直接来自 Claude Code 的使用日志：

- **数据源**: `~/.claude/projects/**/*.jsonl`
- **记录时机**: 每次 API 调用后自动记录
- **Token 计数**: 来自 Anthropic API 响应的准确值
- **无修改**: CCR UI 只读取，不修改原始数据

### 可以导出数据吗？

**当前版本**: 前端暂不支持导出

**替代方案**:
1. 直接访问 JSONL 文件：`~/.claude/projects/**/*.jsonl`
2. 使用新的 V2 API 端点获取数据
3. 复制浏览器 Network 面板的响应数据

**未来计划**:
- CSV 导出
- Excel 导出
- PDF 报告生成

## 最佳实践

### 1. 定期查看统计

建议每周查看一次使用统计，了解：
- Token 使用趋势
- 活跃时间分布
- 缓存效率变化
- 异常使用峰值

### 2. 优化缓存使用

- 查看缓存效率卡片
- 如果效率低于 20%，考虑优化提示词结构
- 将固定内容放在缓存区

### 3. 跨平台对比

- 切换不同平台查看数据
- 对比不同平台的使用模式
- 选择最适合的平台和模型

### 4. 设置自动刷新

长时间监控时启用自动刷新：
- 短期监控：30-60 秒
- 中期监控：2-5 分钟
- 注意：过短的间隔会增加后端负载

### 5. 利用热力图

- 发现活跃时间规律
- 识别使用空窗期
- 规划工作时间

## 相关资源

- [后端 API 文档](../reference/backend/api.md)
- [前端组件文档](../reference/frontend/components.md)
- [统计与成本分析](./stats.md)
- [Anthropic Prompt Caching](https://docs.anthropic.com/claude/docs/prompt-caching)

## 更新日志

### v3.3.2 (2025-11-18)

#### 新功能
- ✅ 添加使用统计分析页面
- ✅ 实现 Token 使用趋势图表
- ✅ 实现 365 天活动热力图
- ✅ 支持多平台切换（Claude/Codex/Gemini）
- ✅ 支持自定义日期范围筛选

#### 后端优化
- ✅ 实现 60 秒 TTL 缓存
- ✅ 添加并行文件处理（Rayon）
- ✅ 优化 JSONL 解析性能
- ✅ 添加数据验证和错误处理

#### 前端优化
- ✅ 修复图表纵坐标对齐问题
- ✅ 统一坐标系统（图表区域、网格线、Y 轴标签）
- ✅ 添加 10% 数据 padding
- ✅ 全部文字中文化
- ✅ 优化刷新按钮样式（绿-青渐变 + 发光效果）
- ✅ 优化筛选控件可见性（加粗边框、彩色图标）
- ✅ 添加图表筛选状态显示（徽章）
- ✅ 改进图例交互（加粗字体、彩色边框）

#### UI/UX 改进
- ✅ 液态玻璃设计（Glassmorphism）
- ✅ 明暗主题完美适配
- ✅ 响应式布局
- ✅ 平滑过渡动画
- ✅ 悬停交互反馈

### 未来规划

#### 数据可视化增强
- 📊 添加柱状图对比模型使用
- 🥧 添加饼图显示 Token 类型分布
- 📈 添加折线图显示成本趋势
- 🎯 添加数据点悬停提示

#### 筛选和导出
- 🔍 添加按项目筛选
- 📅 添加按小时查看（更细粒度）
- 💾 添加 CSV/JSON/Excel 导出
- 📊 添加报告生成功能

#### 性能和体验
- ⚡ 添加筛选防抖
- 🔄 添加加载骨架屏
- 📱 优化移动端布局
- 🎨 添加更多主题选项

---

**提示**: 使用统计分析功能持续优化中，欢迎提供反馈和建议！
