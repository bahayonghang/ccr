# CCR UI Justfile
# ä¸€é”®å®‰è£…ã€æ„å»ºå’Œå¯åŠ¨å‰åç«¯

# é»˜è®¤å‘½ä»¤ï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
default:
    @just help

# æ˜¾ç¤ºå¸¸ç”¨å‘½ä»¤å¸®åŠ©
help:
    @echo "ğŸš€ CCR UI - å¸¸ç”¨å‘½ä»¤"
    @echo "===================="
    @echo ""
    @echo "å¿«é€Ÿå¯åŠ¨:"
    @echo "  just s          = å¯åŠ¨å¼€å‘ç¯å¢ƒï¼ˆdev çš„ç®€åŒ–å‘½ä»¤ï¼‰"
    @echo "  just i          = å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆinstall çš„ç®€åŒ–å‘½ä»¤ï¼‰"
    @echo "  just b          = æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼ˆbuild çš„ç®€åŒ–å‘½ä»¤ï¼‰"
    @echo ""
    @echo "æœ€å¸¸ç”¨å‘½ä»¤:"
    @echo "  just quick-start    ä¸€é”®å¯åŠ¨ï¼ˆæ£€æŸ¥ + å®‰è£… + å¼€å‘ï¼‰"
    @echo "  just dev            å¯åŠ¨å¼€å‘ç¯å¢ƒï¼ˆå‰ç«¯ + åç«¯ï¼‰"
    @echo "  just install        å®‰è£…æ‰€æœ‰ä¾èµ–"
    @echo "  just build          æ„å»ºç”Ÿäº§ç‰ˆæœ¬"
    @echo "  just check          æ£€æŸ¥ä»£ç "
    @echo "  just test           è¿è¡Œæµ‹è¯•"
    @echo ""
    @echo "å•ç‹¬æ“ä½œ:"
    @echo "  just dev-backend    åªå¯åŠ¨åç«¯"
    @echo "  just dev-frontend   åªå¯åŠ¨å‰ç«¯"
    @echo ""
    @echo "å…¶ä»–:"
    @echo "  just info           æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯"
    @echo "  just check-security æ£€æŸ¥å®‰å…¨æ¼æ´"
    @echo "  just --list         æ˜¾ç¤ºæ‰€æœ‰å‘½ä»¤ï¼ˆ40+ï¼‰"
    @echo "  just clean          æ¸…ç†æ„å»ºäº§ç‰©"
    @echo ""
    @echo "ğŸ’¡ æç¤º: è¿è¡Œ 'just info' æŸ¥çœ‹è¯¦ç»†é¡¹ç›®ä¿¡æ¯"

# ===== å®‰è£… =====

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆå‰ç«¯ + åç«¯ï¼‰
install: install-frontend install-backend
    @echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ"

# å®‰è£…å‰ç«¯ä¾èµ–
install-frontend:
    @echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
    cd frontend && npm install
    @echo "âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ"

# å®‰è£…åç«¯ä¾èµ–ï¼ˆæ„å»ºä¸€æ¬¡ä»¥ä¸‹è½½ä¾èµ–ï¼‰
install-backend:
    @echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
    cd backend && cargo build
    @echo "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"

# ===== ç®€åŒ–å‘½ä»¤ï¼ˆåˆ«åï¼‰ =====

# ç®€åŒ–ï¼šå¯åŠ¨å¼€å‘ç¯å¢ƒ
alias s := dev

# ç®€åŒ–ï¼šå®‰è£…ä¾èµ–
alias i := install

# ç®€åŒ–ï¼šæ„å»ºç”Ÿäº§ç‰ˆæœ¬
alias b := build

# ç®€åŒ–ï¼šæ£€æŸ¥ä»£ç 
alias c := check

# ç®€åŒ–ï¼šè¿è¡Œæµ‹è¯•
alias t := test

# ç®€åŒ–ï¼šæ ¼å¼åŒ–ä»£ç 
alias f := fmt

# ===== å¼€å‘ =====

# å¯åŠ¨å¼€å‘ç¯å¢ƒï¼ˆå‰ç«¯ + åç«¯ï¼‰
dev:
    @echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
    @echo "ğŸ“ åç«¯: http://localhost:8081"
    @echo "ğŸ“ å‰ç«¯: http://localhost:5173"
    @echo ""
    @just dev-parallel

# å¹¶è¡Œå¯åŠ¨å‰åç«¯å¼€å‘æœåŠ¡å™¨
dev-parallel:
    #!/usr/bin/env bash
    set -e
    trap 'kill $(jobs -p) 2>/dev/null' EXIT
    cd backend && cargo run &
    sleep 2
    cd frontend && npm run dev &
    wait

# ä»…å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨
dev-backend:
    @echo "ğŸ¦€ å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨..."
    cd backend && cargo run

# ä»…å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
dev-frontend:
    @echo "âš›ï¸  å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨..."
    cd frontend && npm run dev

# ===== æ„å»º =====

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼ˆå‰ç«¯ + åç«¯ï¼‰
build: build-backend build-frontend
    @echo "âœ… ç”Ÿäº§æ„å»ºå®Œæˆ"
    @echo "ğŸ“¦ åç«¯äºŒè¿›åˆ¶: backend/target/release/ccr-ui-backend"
    @echo "ğŸ“¦ å‰ç«¯é™æ€æ–‡ä»¶: frontend/dist/"

# æ„å»ºåç«¯ç”Ÿäº§ç‰ˆæœ¬
build-backend:
    @echo "ğŸ—ï¸  æ„å»ºåç«¯ï¼ˆReleaseï¼‰..."
    cd backend && cargo build --release
    @echo "âœ… åç«¯æ„å»ºå®Œæˆ"

# æ„å»ºå‰ç«¯ç”Ÿäº§ç‰ˆæœ¬
build-frontend:
    @echo "ğŸ—ï¸  æ„å»ºå‰ç«¯..."
    cd frontend && npm run build
    @echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"

# ===== è¿è¡Œç”Ÿäº§ç‰ˆæœ¬ =====

# è¿è¡Œç”Ÿäº§ç‰ˆæœ¬åç«¯
run-prod:
    @echo "ğŸš€ å¯åŠ¨ç”Ÿäº§ç‰ˆæœ¬åç«¯..."
    ./backend/target/release/ccr-ui-backend

# ä½¿ç”¨PythonæœåŠ¡å™¨è¿è¡Œå‰ç«¯é™æ€æ–‡ä»¶
serve-frontend:
    @echo "ğŸŒ å¯åŠ¨å‰ç«¯é™æ€æ–‡ä»¶æœåŠ¡å™¨ï¼ˆç«¯å£5173ï¼‰..."
    cd frontend/dist && python3 -m http.server 5173

# ===== æ£€æŸ¥å’Œæµ‹è¯• =====

# æ£€æŸ¥ä»£ç ï¼ˆä¸æ„å»ºï¼‰
check: check-backend check-frontend
    @echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"

# æ£€æŸ¥åç«¯ä»£ç 
check-backend:
    @echo "ğŸ” æ£€æŸ¥åç«¯ä»£ç ..."
    cd backend && cargo check

# æ£€æŸ¥å‰ç«¯ä»£ç 
check-frontend:
    @echo "ğŸ” æ£€æŸ¥å‰ç«¯ä»£ç ..."
    cd frontend && npm run lint

# æ£€æŸ¥å‰ç«¯å®‰å…¨æ¼æ´
check-security:
    @echo "ğŸ”’ æ£€æŸ¥å‰ç«¯å®‰å…¨æ¼æ´..."
    cd frontend && npm audit
    @echo ""
    @echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ"

# è¿è¡Œæµ‹è¯•
test: test-backend
    @echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"

# è¿è¡Œåç«¯æµ‹è¯•
test-backend:
    @echo "ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•..."
    cd backend && cargo test

# ===== ä»£ç è´¨é‡ =====

# æ ¼å¼åŒ–æ‰€æœ‰ä»£ç 
fmt: fmt-backend fmt-frontend
    @echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# æ ¼å¼åŒ–åç«¯ä»£ç 
fmt-backend:
    @echo "ğŸ’… æ ¼å¼åŒ–åç«¯ä»£ç ..."
    cd backend && cargo fmt

# æ ¼å¼åŒ–å‰ç«¯ä»£ç 
fmt-frontend:
    @echo "ğŸ’… æ ¼å¼åŒ–å‰ç«¯ä»£ç ..."
    cd frontend && npm run lint --fix || true

# Clippy æ£€æŸ¥åç«¯
clippy:
    @echo "ğŸ“ è¿è¡Œ Clippy..."
    cd backend && cargo clippy -- -D warnings

# ===== æ¸…ç† =====

# æ¸…ç†æ‰€æœ‰æ„å»ºäº§ç‰©
clean: clean-backend clean-frontend
    @echo "âœ… æ¸…ç†å®Œæˆ"

# æ¸…ç†åç«¯æ„å»ºäº§ç‰©
clean-backend:
    @echo "ğŸ§¹ æ¸…ç†åç«¯..."
    cd backend && cargo clean

# æ¸…ç†å‰ç«¯æ„å»ºäº§ç‰©
clean-frontend:
    @echo "ğŸ§¹ æ¸…ç†å‰ç«¯..."
    cd frontend && rm -rf dist node_modules

# æ·±åº¦æ¸…ç†ï¼ˆåŒ…æ‹¬ä¾èµ–ï¼‰
clean-all: clean
    @echo "ğŸ§¹ æ·±åº¦æ¸…ç†ï¼ˆåŒ…æ‹¬ä¾èµ–ï¼‰..."
    cd frontend && rm -rf node_modules package-lock.json

# ===== å·¥å…· =====

# æ£€æŸ¥å‰ç½®æ¡ä»¶
check-prereqs:
    #!/usr/bin/env bash
    echo "ğŸ” æ£€æŸ¥å‰ç½®æ¡ä»¶..."
    
    # æ£€æŸ¥ Rust
    if command -v rustc &> /dev/null; then
        echo "âœ… Rust: $(rustc --version)"
    else
        echo "âŒ Rust æœªå®‰è£…"
        exit 1
    fi
    
    # æ£€æŸ¥ Cargo
    if command -v cargo &> /dev/null; then
        echo "âœ… Cargo: $(cargo --version)"
    else
        echo "âŒ Cargo æœªå®‰è£…"
        exit 1
    fi
    
    # æ£€æŸ¥ Node.js
    if command -v node &> /dev/null; then
        echo "âœ… Node.js: $(node --version)"
    else
        echo "âŒ Node.js æœªå®‰è£…"
        exit 1
    fi
    
    # æ£€æŸ¥ npm
    if command -v npm &> /dev/null; then
        echo "âœ… npm: $(npm --version)"
    else
        echo "âŒ npm æœªå®‰è£…"
        exit 1
    fi
    
    # æ£€æŸ¥ CCR
    if command -v ccr &> /dev/null; then
        echo "âœ… CCR: $(ccr --version 2>/dev/null || echo 'installed')"
    else
        echo "âš ï¸  CCR æœªå®‰è£…ï¼ˆåç«¯è¿è¡Œæ—¶éœ€è¦ï¼‰"
    fi
    
    echo ""
    echo "âœ… å‰ç½®æ¡ä»¶æ£€æŸ¥å®Œæˆ"

# æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
info:
    @echo "ğŸ“Š CCR UI é¡¹ç›®ä¿¡æ¯"
    @echo "=================="
    @echo ""
    @echo "ğŸ“ é¡¹ç›®ç»“æ„:"
    @echo "  - backend/  : Actix Web (Rust)"
    @echo "  - frontend/ : React + Vite (TypeScript)"
    @echo ""
    @echo "ğŸŒ å¼€å‘ç«¯å£:"
    @echo "  - åç«¯: http://localhost:8081"
    @echo "  - å‰ç«¯: http://localhost:5173"
    @echo ""
    @echo "ğŸ“¦ å¸¸ç”¨å‘½ä»¤:"
    @echo "  just install    - å®‰è£…æ‰€æœ‰ä¾èµ–"
    @echo "  just dev        - å¯åŠ¨å¼€å‘ç¯å¢ƒ"
    @echo "  just build      - æ„å»ºç”Ÿäº§ç‰ˆæœ¬"
    @echo "  just check      - æ£€æŸ¥ä»£ç "
    @echo "  just clean      - æ¸…ç†æ„å»ºäº§ç‰©"
    @echo ""
    @echo "ğŸ“š æ›´å¤šå‘½ä»¤: just --list"

# å¿«é€Ÿå¯åŠ¨ï¼ˆæ£€æŸ¥ + å®‰è£… + å¼€å‘ï¼‰
quick-start: check-prereqs install dev

# æ›´æ–°ä¾èµ–
update: update-backend update-frontend
    @echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆ"

# æ›´æ–°åç«¯ä¾èµ–
update-backend:
    @echo "â¬†ï¸  æ›´æ–°åç«¯ä¾èµ–..."
    cd backend && cargo update

# æ›´æ–°å‰ç«¯ä¾èµ–
update-frontend:
    @echo "â¬†ï¸  æ›´æ–°å‰ç«¯ä¾èµ–..."
    cd frontend && npm update

# ===== è¾…åŠ©å‘½ä»¤ =====

# æŸ¥çœ‹åç«¯æ—¥å¿—ï¼ˆéœ€è¦å…ˆå¯åŠ¨ï¼‰
logs-backend:
    @echo "ğŸ“‹ åç«¯æ—¥å¿—..."
    # è¿™é‡Œå¯ä»¥æ·»åŠ æ—¥å¿—æŸ¥çœ‹å‘½ä»¤

# æŸ¥çœ‹å‰ç«¯æ—¥å¿—ï¼ˆéœ€è¦å…ˆå¯åŠ¨ï¼‰
logs-frontend:
    @echo "ğŸ“‹ å‰ç«¯æ—¥å¿—..."
    # è¿™é‡Œå¯ä»¥æ·»åŠ æ—¥å¿—æŸ¥çœ‹å‘½ä»¤

# ç›‘è§†æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨é‡å¯åç«¯
watch-backend:
    @echo "ğŸ‘€ ç›‘è§†åç«¯æ–‡ä»¶å˜åŒ–..."
    cd backend && cargo watch -x run

# è¿è¡Œåç«¯æ€§èƒ½æµ‹è¯•
bench-backend:
    @echo "âš¡ è¿è¡Œåç«¯æ€§èƒ½æµ‹è¯•..."
    cd backend && cargo bench

# ç”Ÿæˆåç«¯æ–‡æ¡£
doc-backend:
    @echo "ğŸ“š ç”Ÿæˆåç«¯æ–‡æ¡£..."
    cd backend && cargo doc --no-deps --open

# ===== éƒ¨ç½²ç›¸å…³ =====

# å®Œæ•´çš„ CI æµç¨‹
ci: check test build
    @echo "âœ… CI æµç¨‹å®Œæˆ"

# å‡†å¤‡å‘å¸ƒ
prepare-release: clean build
    @echo "âœ… å‘å¸ƒå‡†å¤‡å®Œæˆ"
    @echo ""
    @echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶:"
    @echo "  - backend/target/release/ccr-ui-backend"
    @echo "  - frontend/dist/"

