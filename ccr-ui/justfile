# CCR UI Justfile
# ä¸€é”®å®‰è£…ã€æ„å»ºå’Œå¯åŠ¨å‰åç«¯
# æ”¯æŒ Windowsã€Linuxã€macOS è·¨å¹³å°

# ğŸ§­ è·¨å¹³å° Shell é…ç½®
# Windows ä½¿ç”¨ PowerShell with UTF-8 encoding
set windows-shell := ["pwsh.exe", "-NoLogo", "-NoProfile", "-Command", "$OutputEncoding = [Console]::OutputEncoding = [System.Text.Encoding]::UTF8;"]

# Unix-like ç³»ç»Ÿä½¿ç”¨ bash
set shell := ["bash", "-cu"]

# ğŸŒ æ“ä½œç³»ç»Ÿæ£€æµ‹ï¼ˆä¾›æ¡ä»¶åˆ¤æ–­ä½¿ç”¨ï¼‰
is_windows := if os() == "windows" { "true" } else { "false" }
is_macos := if os() == "macos" { "true" } else { "false" }
is_linux := if os() == "linux" { "true" } else { "false" }

# é»˜è®¤å‘½ä»¤ï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
default:
    @just help

# æ˜¾ç¤ºå¸¸ç”¨å‘½ä»¤å¸®åŠ©
help:
    @echo "ğŸš€ CCR UI - å¸¸ç”¨å‘½ä»¤"
    @echo "===================="
    @echo ""
    @echo "å¿«é€Ÿå¯åŠ¨:"
    @echo "  just s          = å¯åŠ¨å¼€å‘ç¯å¢ƒï¼ˆdev çš„ç®€åŒ–å‘½ä»¤ï¼‰"
    @echo "  just i          = å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆinstall çš„ç®€åŒ–å‘½ä»¤ï¼‰"
    @echo "  just b          = æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼ˆbuild çš„ç®€åŒ–å‘½ä»¤ï¼‰"
    @echo ""
    @echo "æœ€å¸¸ç”¨å‘½ä»¤:"
    @echo "  just quick-start    ä¸€é”®å¯åŠ¨ï¼ˆæ£€æŸ¥ + å®‰è£… + å¼€å‘ï¼‰"
    @echo "  just dev            å¯åŠ¨å¼€å‘ç¯å¢ƒï¼ˆVue 3 å‰ç«¯ + åç«¯ï¼‰"
    @echo "  just dev-react      å¯åŠ¨ React å¼€å‘ç¯å¢ƒï¼ˆNext.js å‰ç«¯ + åç«¯ï¼‰"
    @echo "  just install        å®‰è£…æ‰€æœ‰ä¾èµ–"
    @echo "  just build          æ„å»ºç”Ÿäº§ç‰ˆæœ¬"
    @echo "  just check          æ£€æŸ¥ä»£ç "
    @echo "  just test           è¿è¡Œæµ‹è¯•"
    @echo ""
    @echo "ğŸ–¥ï¸  Tauri æ¡Œé¢åº”ç”¨:"
    @echo "  just tauri-dev      å¯åŠ¨ Tauri å¼€å‘æ¨¡å¼ï¼ˆæ¡Œé¢åº”ç”¨ï¼‰"
    @echo "  just tauri-build    æ„å»º Tauri ç”Ÿäº§ç‰ˆæœ¬"
    @echo "  just tauri-check    æ£€æŸ¥ Tauri ç¯å¢ƒå’Œé…ç½®"
    @echo ""
    @echo "å•ç‹¬æ“ä½œ:"
    @echo "  just dev-backend       åªå¯åŠ¨åç«¯"
    @echo "  just dev-frontend      åªå¯åŠ¨ Vue å‰ç«¯"
    @echo "  just dev-react-frontend  åªå¯åŠ¨ Next.js å‰ç«¯"
    @echo ""
    @echo "å…¶ä»–:"
    @echo "  just info           æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯"
    @echo "  just check-security æ£€æŸ¥å®‰å…¨æ¼æ´"
    @echo "  just --list         æ˜¾ç¤ºæ‰€æœ‰å‘½ä»¤ï¼ˆ40+ï¼‰"
    @echo "  just clean          æ¸…ç†æ„å»ºäº§ç‰©"
    @echo ""
    @echo "ğŸ’¡ æç¤º: è¿è¡Œ 'just info' æŸ¥çœ‹è¯¦ç»†é¡¹ç›®ä¿¡æ¯"

# ===== å®‰è£… =====

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆå‰ç«¯ + åç«¯ï¼‰
install: install-frontend install-backend
    @echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ"
    @echo "ğŸ’¡ æç¤ºï¼šå¯è¿è¡Œ just quick-start ä¸€é”®å¯åŠ¨å¼€å‘ç¯å¢ƒ"

# å®‰è£…å‰ç«¯ä¾èµ–
install-frontend:
    @just _install-frontend-{{os()}}

_install-frontend-linux:
    @echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
    cd frontend && npm install
    @echo "âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ"

_install-frontend-macos:
    @echo "ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–..."
    cd frontend && npm install
    @echo "âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ"

_install-frontend-windows:
    @Write-Output 'ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–...'
    @Set-Location frontend; npm install
    @Write-Output 'âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ'

# å®‰è£…åç«¯ä¾èµ–ï¼ˆæ„å»ºä¸€æ¬¡ä»¥ä¸‹è½½ä¾èµ–ï¼‰
install-backend:
    @just _install-backend-{{os()}}

_install-backend-linux:
    @echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
    cd backend && cargo build
    @echo "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"

_install-backend-macos:
    @echo "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
    cd backend && cargo build
    @echo "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"

_install-backend-windows:
    @Write-Output 'ğŸ“¦ å®‰è£…åç«¯ä¾èµ–...'
    @Set-Location backend; cargo build
    @Write-Output 'âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ'

# ===== ç®€åŒ–å‘½ä»¤ï¼ˆåˆ«åï¼‰ =====
# å¿«æ·åˆ«åä¿æŒè·¨å¹³å°ä¸€è‡´

# ç®€åŒ–ï¼šå¯åŠ¨å¼€å‘ç¯å¢ƒ
alias s := dev

# ç®€åŒ–ï¼šå®‰è£…ä¾èµ–
alias i := install

# ç®€åŒ–ï¼šæ„å»ºç”Ÿäº§ç‰ˆæœ¬
alias b := build

# ç®€åŒ–ï¼šæ£€æŸ¥ä»£ç 
alias c := check

# ç®€åŒ–ï¼šè¿è¡Œæµ‹è¯•
alias t := test

# ç®€åŒ–ï¼šæ ¼å¼åŒ–ä»£ç 
alias f := fmt

# ===== å¼€å‘ =====

# å¯åŠ¨å¼€å‘ç¯å¢ƒï¼ˆVue å‰ç«¯ + åç«¯ï¼‰
dev: dev-clean
    @just _dev-start-{{os()}}

_dev-start-linux:
    @echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
    @echo "ğŸ“ åç«¯: http://localhost:8081"
    @echo "ğŸ“ å‰ç«¯: http://localhost:5173 (Vue 3 + Vite)"
    @echo ""
    @just dev-parallel

_dev-start-macos:
    @echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
    @echo "ğŸ“ åç«¯: http://localhost:8081"
    @echo "ğŸ“ å‰ç«¯: http://localhost:5173 (Vue 3 + Vite)"
    @echo ""
    @just dev-parallel

_dev-start-windows:
    @Write-Output 'ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ...'
    @Write-Output 'ğŸ“ åç«¯: http://localhost:8081'
    @Write-Output 'ğŸ“ å‰ç«¯: http://localhost:5173 (Vue 3 + Vite)'
    @Write-Output ''
    @just dev-parallel

# å¹¶è¡Œå¯åŠ¨å‰åç«¯å¼€å‘æœåŠ¡å™¨ï¼ˆè·¨å¹³å°ï¼‰
dev-parallel:
    @just _dev-parallel-{{os()}}

# å¹¶è¡Œå¯åŠ¨å‰åç«¯å¼€å‘æœåŠ¡å™¨ï¼ˆè·¨å¹³å°ï¼‰
# å¹¶è¡Œå¯åŠ¨ - Unix/Linux/macOS
_dev-parallel-linux:
    #!/usr/bin/env bash
    set -e
    JDIR="{{justfile_directory()}}"
    mkdir -p "$JDIR/logs"
    trap 'kill $(jobs -p) 2>/dev/null' EXIT
    # å¯åŠ¨åç«¯å¹¶è®°å½•æ—¥å¿—
    cd "$JDIR/backend" && cargo run 2>&1 | tee -a "$JDIR/logs/backend-console.log" &
    BACK_PID=$!
    # è½®è¯¢åç«¯å¥åº·æ£€æŸ¥ï¼Œé¿å…å‰ç«¯åœ¨åç«¯æœªå°±ç»ªæ—¶å¯åŠ¨
    echo "â³ ç­‰å¾…åç«¯å°±ç»ª (http://127.0.0.1:8081/health)..."
    if command -v curl >/dev/null 2>&1; then
      for i in $(seq 1 90); do
        if curl -sf http://127.0.0.1:8081/health >/dev/null 2>&1; then
          echo "âœ… åç«¯å°±ç»ª"
          break
        fi
        # åç«¯è¿›ç¨‹å¼‚å¸¸é€€å‡ºåˆ™ç«‹å³å¤±è´¥
        if ! kill -0 $BACK_PID 2>/dev/null; then
          echo "âŒ åç«¯è¿›ç¨‹å·²é€€å‡ºï¼Œè¯·æŸ¥çœ‹ logs/backend-console.log"
          exit 1
        fi
        sleep 1
        if [ "$i" -eq 90 ]; then
          echo "âŒ ç­‰å¾…åç«¯è¶…æ—¶(90s)ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—"
          exit 1
        fi
      done
    else
      echo "âš ï¸ æœªæ£€æµ‹åˆ° curlï¼Œå›ºå®šç­‰å¾… 5 ç§’åå¯åŠ¨å‰ç«¯"
      for i in $(seq 1 5); do
        if ! kill -0 $BACK_PID 2>/dev/null; then
          echo "âŒ åç«¯è¿›ç¨‹å·²é€€å‡ºï¼Œè¯·æŸ¥çœ‹ logs/backend-console.log"
          exit 1
        fi
        sleep 1
      done
    fi
    # å¯åŠ¨å‰ç«¯å¹¶è®°å½•æ—¥å¿—
    cd "$JDIR/frontend" && npm run dev -- --host 0.0.0.0 2>&1 | tee -a "$JDIR/logs/frontend.log" &
    wait

_dev-parallel-macos:
    #!/usr/bin/env bash
    set -e
    JDIR="{{justfile_directory()}}"
    mkdir -p "$JDIR/logs"
    trap 'kill $(jobs -p) 2>/dev/null' EXIT
    # å¯åŠ¨åç«¯å¹¶è®°å½•æ—¥å¿—
    cd "$JDIR/backend" && cargo run 2>&1 | tee -a "$JDIR/logs/backend-console.log" &
    BACK_PID=$!
    # è½®è¯¢åç«¯å¥åº·æ£€æŸ¥ï¼Œé¿å…å‰ç«¯åœ¨åç«¯æœªå°±ç»ªæ—¶å¯åŠ¨
    echo "â³ ç­‰å¾…åç«¯å°±ç»ª (http://127.0.0.1:8081/health)..."
    if command -v curl >/dev/null 2>&1; then
      for i in $(seq 1 90); do
        if curl -sf http://127.0.0.1:8081/health >/dev/null 2>&1; then
          echo "âœ… åç«¯å°±ç»ª"
          break
        fi
        # åç«¯è¿›ç¨‹å¼‚å¸¸é€€å‡ºåˆ™ç«‹å³å¤±è´¥
        if ! kill -0 $BACK_PID 2>/dev/null; then
          echo "âŒ åç«¯è¿›ç¨‹å·²é€€å‡ºï¼Œè¯·æŸ¥çœ‹ logs/backend-console.log"
          exit 1
        fi
        sleep 1
        if [ "$i" -eq 90 ]; then
          echo "âŒ ç­‰å¾…åç«¯è¶…æ—¶(90s)ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—"
          exit 1
        fi
      done
    else
      echo "âš ï¸ æœªæ£€æµ‹åˆ° curlï¼Œå›ºå®šç­‰å¾… 5 ç§’åå¯åŠ¨å‰ç«¯"
      for i in $(seq 1 5); do
        if ! kill -0 $BACK_PID 2>/dev/null; then
          echo "âŒ åç«¯è¿›ç¨‹å·²é€€å‡ºï¼Œè¯·æŸ¥çœ‹ logs/backend-console.log"
          exit 1
        fi
        sleep 1
      done
    fi
    # å¯åŠ¨å‰ç«¯å¹¶è®°å½•æ—¥å¿—
    cd "$JDIR/frontend" && npm run dev -- --host 0.0.0.0 2>&1 | tee -a "$JDIR/logs/frontend.log" &
    wait

# å¹¶è¡Œå¯åŠ¨ - Windows
# âš ï¸ Windows ä½¿ç”¨ Start-Process ä»¥ä¿æŒå­è¿›ç¨‹åœ¨åå°è¿è¡Œ
_dev-parallel-windows:
    @if (-not (Test-Path logs)) { New-Item -ItemType Directory -Path logs -Force | Out-Null }
    @Write-Output 'ğŸ¦€ å¯åŠ¨åç«¯æœåŠ¡å™¨...'; Start-Process powershell -ArgumentList '-NoExit', '-Command', 'cd backend; cargo run 2>&1 | Tee-Object -FilePath ../logs/backend-console.log -Append' -WindowStyle Normal
    @$maxWait=90; Write-Output 'â³ ç­‰å¾…åç«¯å°±ç»ª (http://127.0.0.1:8081/health)...'; for($i=0; $i -lt $maxWait; $i++){ try { $r = Invoke-WebRequest -UseBasicParsing -TimeoutSec 2 -Uri 'http://127.0.0.1:8081/health'; if($r.StatusCode -eq 200){ Write-Output 'âœ… åç«¯å°±ç»ª'; break } } catch { } Start-Sleep -Seconds 1; if($i -eq ($maxWait-1)){ Write-Output 'âŒ ç­‰å¾…åç«¯è¶…æ—¶(90s)ï¼Œè¯·æ£€æŸ¥ logs/backend-console.log'; exit 1 } }
    @Write-Output 'âš›ï¸ å¯åŠ¨å‰ç«¯æœåŠ¡å™¨...'; Start-Process powershell -ArgumentList '-NoExit', '-Command', 'cd frontend; npm run dev 2>&1 | Tee-Object -FilePath ../logs/frontend.log -Append' -WindowStyle Normal
    @Write-Output 'ğŸ“œ æ—¥å¿—ä½äº logs/backend-console.log ä¸ logs/frontend.log'
    @Write-Output 'ğŸ’¡ æç¤º: ä¸¤ä¸ªæ–°çª—å£å·²æ‰“å¼€ï¼Œå…³é—­çª—å£å³å¯åœæ­¢æœåŠ¡å™¨'

# å¹¶è¡Œå¯åŠ¨ - Unix/Linux/macOS
# å¯åŠ¨å‰æ¸…ç†ï¼ˆç«¯å£ + ç¼“å­˜ + æ®‹ç•™è¿›ç¨‹ï¼‰
dev-clean:
    @just _dev-clean-{{os()}}

# æ¸…ç†å¼€å‘ç¯å¢ƒ - Linux
_dev-clean-linux:
    #!/usr/bin/env bash
    set -e
    echo "ğŸ§¹ å¼€å§‹æ¸…ç†å¼€å‘ç¯å¢ƒ..."
    pkill -9 -f "ccr-ui-backend" 2>/dev/null || true
    pkill -9 -f "vite" 2>/dev/null || true
    pkill -9 -f "next-server" 2>/dev/null || true
    pkill -9 -f "next dev" 2>/dev/null || true
    lsof -ti:8081 2>/dev/null | xargs -r kill -9 || true
    lsof -ti:5173 2>/dev/null | xargs -r kill -9 || true
    lsof -ti:5174 2>/dev/null | xargs -r kill -9 || true
    lsof -ti:3000 2>/dev/null | xargs -r kill -9 || true
    rm -rf frontend/.next 2>/dev/null || true
    echo "âœ… æ¸…ç†å®Œæˆ"

# æ¸…ç†å¼€å‘ç¯å¢ƒ - macOS
_dev-clean-macos:
    #!/usr/bin/env bash
    set -e
    echo "ğŸ§¹ å¼€å§‹æ¸…ç†å¼€å‘ç¯å¢ƒ..."
    pkill -9 -f "ccr-ui-backend" 2>/dev/null || true
    pkill -9 -f "vite" 2>/dev/null || true
    pkill -9 -f "next-server" 2>/dev/null || true
    pkill -9 -f "next dev" 2>/dev/null || true
    lsof -ti:8081 2>/dev/null | xargs kill -9 || true
    lsof -ti:5173 2>/dev/null | xargs kill -9 || true
    lsof -ti:5174 2>/dev/null | xargs kill -9 || true
    lsof -ti:3000 2>/dev/null | xargs kill -9 || true
    rm -rf frontend/.next 2>/dev/null || true
    echo "âœ… æ¸…ç†å®Œæˆ"

# æ¸…ç†å¼€å‘ç¯å¢ƒ - Windows
_dev-clean-windows:
    @Write-Output 'ğŸ§¹ å¼€å§‹æ¸…ç†å¼€å‘ç¯å¢ƒ...'
    @powershell -ExecutionPolicy Bypass -File scripts/clean_dev.ps1
    @Write-Output '... æ¸…ç†å‰ç«¯æ„å»ºç›®å½•...'
    @if (Test-Path 'frontend/.next') { Remove-Item -Recurse -Force 'frontend/.next' }
    @Write-Output 'âœ… æ¸…ç†å®Œæˆ'

# å¯åŠ¨å‰æ¸…ç†ï¼ˆç«¯å£ + ç¼“å­˜ + æ®‹ç•™è¿›ç¨‹ï¼‰
# ä»…å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨
dev-backend:
    @just _dev-backend-{{os()}}

_dev-backend-linux:
    @echo "ğŸ¦€ å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨..."
    cd backend && cargo run

_dev-backend-macos:
    @echo "ğŸ¦€ å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨..."
    cd backend && cargo run

_dev-backend-windows:
    @Write-Output 'ğŸ¦€ å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨...'
    @Set-Location backend; cargo run

# ä»…å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨ï¼ˆVueï¼‰
dev-frontend:
    @just _dev-frontend-{{os()}}

_dev-frontend-linux:
    @echo "âš›ï¸  å¯åŠ¨ Vue å‰ç«¯å¼€å‘æœåŠ¡å™¨..."
    cd frontend && npm run dev

_dev-frontend-macos:
    @echo "âš›ï¸  å¯åŠ¨ Vue å‰ç«¯å¼€å‘æœåŠ¡å™¨..."
    cd frontend && npm run dev

_dev-frontend-windows:
    @Write-Output 'âš›ï¸  å¯åŠ¨ Vue å‰ç«¯å¼€å‘æœåŠ¡å™¨...'
    @Set-Location frontend; npm run dev

# ä»…å¯åŠ¨ React å‰ç«¯å¼€å‘æœåŠ¡å™¨ï¼ˆNext.jsï¼‰
dev-react-frontend:
    @just _dev-react-frontend-{{os()}}

_dev-react-frontend-linux:
    @echo "âš›ï¸  å¯åŠ¨ React å‰ç«¯å¼€å‘æœåŠ¡å™¨..."
    cd frontend && npm run dev

_dev-react-frontend-macos:
    @echo "âš›ï¸  å¯åŠ¨ React å‰ç«¯å¼€å‘æœåŠ¡å™¨..."
    cd frontend && npm run dev

_dev-react-frontend-windows:
    @Write-Output 'âš›ï¸  å¯åŠ¨ React å‰ç«¯å¼€å‘æœåŠ¡å™¨...'
    @Set-Location frontend; npm run dev

# ===== æ„å»º =====

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼ˆå‰ç«¯ + åç«¯ï¼‰
build: build-backend build-frontend
    @just _build-summary-{{os()}}

_build-summary-linux:
    @echo "âœ… ç”Ÿäº§æ„å»ºå®Œæˆ"
    @echo "ğŸ“¦ åç«¯äºŒè¿›åˆ¶: backend/target/release/ccr-ui-backend"
    @echo "ğŸ“¦ å‰ç«¯é™æ€æ–‡ä»¶: frontend/dist/"

_build-summary-macos:
    @echo "âœ… ç”Ÿäº§æ„å»ºå®Œæˆ"
    @echo "ğŸ“¦ åç«¯äºŒè¿›åˆ¶: backend/target/release/ccr-ui-backend"
    @echo "ğŸ“¦ å‰ç«¯é™æ€æ–‡ä»¶: frontend/dist/"

_build-summary-windows:
    @Write-Output 'âœ… ç”Ÿäº§æ„å»ºå®Œæˆ'
    @Write-Output 'ğŸ“¦ åç«¯äºŒè¿›åˆ¶: backend/target/release/ccr-ui-backend.exe'
    @Write-Output 'ğŸ“¦ å‰ç«¯é™æ€æ–‡ä»¶: frontend/dist'

# æ„å»ºåç«¯ç”Ÿäº§ç‰ˆæœ¬
build-backend:
    @just _build-backend-{{os()}}

_build-backend-linux:
    @echo "ğŸ—ï¸  æ„å»ºåç«¯ï¼ˆReleaseï¼‰..."
    cd backend && cargo build --release
    @echo "âœ… åç«¯æ„å»ºå®Œæˆ"

_build-backend-macos:
    @echo "ğŸ—ï¸  æ„å»ºåç«¯ï¼ˆReleaseï¼‰..."
    cd backend && cargo build --release
    @echo "âœ… åç«¯æ„å»ºå®Œæˆ"

_build-backend-windows:
    @Write-Output 'ğŸ—ï¸  æ„å»ºåç«¯ï¼ˆReleaseï¼‰...'
    @Set-Location backend; cargo build --release
    @Write-Output 'âœ… åç«¯æ„å»ºå®Œæˆ'

# æ„å»ºå‰ç«¯ç”Ÿäº§ç‰ˆæœ¬
build-frontend:
    @just _build-frontend-{{os()}}

_build-frontend-linux:
    @echo "ğŸ—ï¸  æ„å»ºå‰ç«¯..."
    cd frontend && npm run build
    @echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"

_build-frontend-macos:
    @echo "ğŸ—ï¸  æ„å»ºå‰ç«¯..."
    cd frontend && npm run build
    @echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"

_build-frontend-windows:
    @Write-Output 'ğŸ—ï¸  æ„å»ºå‰ç«¯...'
    @Set-Location frontend; npm run build
    @Write-Output 'âœ… å‰ç«¯æ„å»ºå®Œæˆ'

# ===== è¿è¡Œç”Ÿäº§ç‰ˆæœ¬ =====

# è¿è¡Œç”Ÿäº§ç‰ˆæœ¬åç«¯
run-prod:
    @just _run-prod-{{os()}}

# è¿è¡Œç”Ÿäº§ç‰ˆæœ¬ - Unix/Linux/macOS
_run-prod-linux:
    @echo "ğŸš€ å¯åŠ¨ç”Ÿäº§ç‰ˆæœ¬åç«¯..."
    ./backend/target/release/ccr-ui-backend

_run-prod-macos:
    @echo "ğŸš€ å¯åŠ¨ç”Ÿäº§ç‰ˆæœ¬åç«¯..."
    ./backend/target/release/ccr-ui-backend

# è¿è¡Œç”Ÿäº§ç‰ˆæœ¬ - Windows
_run-prod-windows:
    @Write-Output 'ğŸš€ å¯åŠ¨ç”Ÿäº§ç‰ˆæœ¬åç«¯...'
    @backend/target/release/ccr-ui-backend.exe

# ä½¿ç”¨PythonæœåŠ¡å™¨è¿è¡Œå‰ç«¯é™æ€æ–‡ä»¶
serve-frontend:
    @just _serve-frontend-{{os()}}

# å¯åŠ¨å‰ç«¯é™æ€æœåŠ¡ - Unix/Linux/macOS
_serve-frontend-linux:
    @echo "ğŸŒ å¯åŠ¨å‰ç«¯é™æ€æ–‡ä»¶æœåŠ¡å™¨ï¼ˆç«¯å£5173ï¼‰..."
    cd frontend/dist && python3 -m http.server 5173

_serve-frontend-macos:
    @echo "ğŸŒ å¯åŠ¨å‰ç«¯é™æ€æ–‡ä»¶æœåŠ¡å™¨ï¼ˆç«¯å£5173ï¼‰..."
    cd frontend/dist && python3 -m http.server 5173

# å¯åŠ¨å‰ç«¯é™æ€æœåŠ¡ - Windows
_serve-frontend-windows:
    @Write-Output 'ğŸŒ å¯åŠ¨å‰ç«¯é™æ€æ–‡ä»¶æœåŠ¡å™¨ï¼ˆç«¯å£5173ï¼‰...'
    @Set-Location frontend/dist; python -m http.server 5173

# ===== æ£€æŸ¥å’Œæµ‹è¯• =====

# æ£€æŸ¥ä»£ç ï¼ˆä¸æ„å»ºï¼‰
check: check-backend check-frontend
    @just _check-summary-{{os()}}

_check-summary-linux:
    @echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"

_check-summary-macos:
    @echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"

_check-summary-windows:
    @Write-Output 'âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡'

# æ£€æŸ¥åç«¯ä»£ç 
check-backend:
    @just _check-backend-{{os()}}

_check-backend-linux:
    @echo "ğŸ” æ£€æŸ¥åç«¯ä»£ç ..."
    cd backend && cargo check

_check-backend-macos:
    @echo "ğŸ” æ£€æŸ¥åç«¯ä»£ç ..."
    cd backend && cargo check

_check-backend-windows:
    @Write-Output 'ğŸ” æ£€æŸ¥åç«¯ä»£ç ...'
    @Set-Location backend; cargo check

# æ£€æŸ¥å‰ç«¯ä»£ç 
check-frontend:
    @just _check-frontend-{{os()}}

_check-frontend-linux:
    @echo "ğŸ” æ£€æŸ¥å‰ç«¯ä»£ç ..."
    cd frontend && npm run lint

_check-frontend-macos:
    @echo "ğŸ” æ£€æŸ¥å‰ç«¯ä»£ç ..."
    cd frontend && npm run lint

_check-frontend-windows:
    @Write-Output 'ğŸ” æ£€æŸ¥å‰ç«¯ä»£ç ...'
    @Set-Location frontend; npm run lint

# æ£€æŸ¥å‰ç«¯å®‰å…¨æ¼æ´
check-security:
    @just _check-security-{{os()}}

_check-security-linux:
    @echo "ğŸ”’ æ£€æŸ¥å‰ç«¯å®‰å…¨æ¼æ´..."
    cd frontend && npm audit
    @echo ""
    @echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ"

_check-security-macos:
    @echo "ğŸ”’ æ£€æŸ¥å‰ç«¯å®‰å…¨æ¼æ´..."
    cd frontend && npm audit
    @echo ""
    @echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ"

_check-security-windows:
    @Write-Output 'ğŸ”’ æ£€æŸ¥å‰ç«¯å®‰å…¨æ¼æ´...'
    @Set-Location frontend; npm audit
    @Write-Output ''
    @Write-Output 'âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ'

# è¿è¡Œæµ‹è¯•
test: test-backend
    @just _test-summary-{{os()}}

_test-summary-linux:
    @echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"

_test-summary-macos:
    @echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"

_test-summary-windows:
    @Write-Output 'âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡'

# è¿è¡Œåç«¯æµ‹è¯•
test-backend:
    @just _test-backend-{{os()}}

_test-backend-linux:
    @echo "ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•..."
    cd backend && cargo test

_test-backend-macos:
    @echo "ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•..."
    cd backend && cargo test

_test-backend-windows:
    @Write-Output 'ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•...'
    @Set-Location backend; cargo test

# ===== ä»£ç è´¨é‡ =====

# æ ¼å¼åŒ–æ‰€æœ‰ä»£ç 
fmt: fmt-backend fmt-frontend
    @just _fmt-summary-{{os()}}

_fmt-summary-linux:
    @echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

_fmt-summary-macos:
    @echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

_fmt-summary-windows:
    @Write-Output 'âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ'

# æ ¼å¼åŒ–åç«¯ä»£ç 
fmt-backend:
    @just _fmt-backend-{{os()}}

_fmt-backend-linux:
    @echo "ğŸ’… æ ¼å¼åŒ–åç«¯ä»£ç ..."
    cd backend && cargo fmt

_fmt-backend-macos:
    @echo "ğŸ’… æ ¼å¼åŒ–åç«¯ä»£ç ..."
    cd backend && cargo fmt

_fmt-backend-windows:
    @Write-Output 'ğŸ’… æ ¼å¼åŒ–åç«¯ä»£ç ...'
    @Set-Location backend; cargo fmt

# æ ¼å¼åŒ–å‰ç«¯ä»£ç 
fmt-frontend:
    @just _fmt-frontend-{{os()}}

_fmt-frontend-linux:
    @echo "ğŸ’… æ ¼å¼åŒ–å‰ç«¯ä»£ç ..."
    cd frontend && npm run lint --fix || true

_fmt-frontend-macos:
    @echo "ğŸ’… æ ¼å¼åŒ–å‰ç«¯ä»£ç ..."
    cd frontend && npm run lint --fix || true

_fmt-frontend-windows:
    @Write-Output 'ğŸ’… æ ¼å¼åŒ–å‰ç«¯ä»£ç ...'
    @Set-Location frontend; npm run lint --fix; if (-not $?) { Write-Host 'âš ï¸ å‰ç«¯æ ¼å¼åŒ–é‡åˆ°é—®é¢˜ï¼Œä½†ç»§ç»­æµç¨‹' -ForegroundColor Yellow }

# Clippy æ£€æŸ¥åç«¯
clippy:
    @just _clippy-{{os()}}

_clippy-linux:
    @echo "ğŸ“ è¿è¡Œ Clippy..."
    cd backend && cargo clippy -- -D warnings

_clippy-macos:
    @echo "ğŸ“ è¿è¡Œ Clippy..."
    cd backend && cargo clippy -- -D warnings

_clippy-windows:
    @Write-Output 'ğŸ“ è¿è¡Œ Clippy...'
    @Set-Location backend; cargo clippy -- -D warnings

# ===== æ¸…ç† =====

# æ¸…ç†æ‰€æœ‰æ„å»ºäº§ç‰©
clean: clean-backend clean-frontend
    @echo "âœ… æ¸…ç†å®Œæˆ"

clean-backend:
    @just _clean-backend-{{os()}}

_clean-backend-linux:
    @echo "ğŸ§¹ æ¸…ç†åç«¯..."
    cd backend && cargo clean

_clean-backend-macos:
    @echo "ğŸ§¹ æ¸…ç†åç«¯..."
    cd backend && cargo clean

_clean-backend-windows:
    @Write-Output 'ğŸ§¹ æ¸…ç†åç«¯...'
    @Set-Location backend; cargo clean

# æ¸…ç†å‰ç«¯æ„å»ºäº§ç‰©
clean-frontend:
    @just _clean-frontend-{{os()}}

# æ¸…ç†å‰ç«¯ - Unix/Linux/macOS
_clean-frontend-linux:
    @echo "ğŸ§¹ æ¸…ç†å‰ç«¯..."
    cd frontend && rm -rf dist node_modules

_clean-frontend-macos:
    @echo "ğŸ§¹ æ¸…ç†å‰ç«¯..."
    cd frontend && rm -rf dist node_modules

# æ¸…ç†å‰ç«¯ - Windows
_clean-frontend-windows:
    @Write-Output 'ğŸ§¹ æ¸…ç†å‰ç«¯...'
    @if (Test-Path 'frontend/dist') { Remove-Item -Recurse -Force 'frontend/dist' }
    @if (Test-Path 'frontend/node_modules') { Remove-Item -Recurse -Force 'frontend/node_modules' }

# æ¸…ç†æ—§æ—¥å¿—æ–‡ä»¶ï¼ˆä¿ç•™14å¤©ï¼‰
clean-logs:
    @just _clean-logs-{{os()}}

# æ¸…ç†æ—¥å¿— - Unix/Linux/macOS
_clean-logs-linux:
    @echo "ğŸ§¹ æ¸…ç†æ—§æ—¥å¿—æ–‡ä»¶..."
    @find logs -name "*.log" -mtime +14 -delete 2>/dev/null || true
    @echo "âœ… å·²åˆ é™¤14å¤©å‰çš„æ—¥å¿—"

_clean-logs-macos:
    @echo "ğŸ§¹ æ¸…ç†æ—§æ—¥å¿—æ–‡ä»¶..."
    @find logs -name "*.log" -mtime +14 -delete 2>/dev/null || true
    @echo "âœ… å·²åˆ é™¤14å¤©å‰çš„æ—¥å¿—"

# æ¸…ç†æ—¥å¿— - Windows
_clean-logs-windows:
    @Write-Output 'ğŸ§¹ æ¸…ç†æ—§æ—¥å¿—æ–‡ä»¶...'
    @$date = (Get-Date).AddDays(-14); if (Test-Path logs) { Get-ChildItem -Path logs -Filter *.log -Recurse | Where-Object { $_.LastWriteTime -lt $date } | Remove-Item -Force }
    @Write-Output 'âœ… å·²åˆ é™¤14å¤©å‰çš„æ—¥å¿—'

# æ·±åº¦æ¸…ç†ï¼ˆåŒ…æ‹¬ä¾èµ–ï¼‰
clean-all: clean
    @just _clean-all-{{os()}}

# æ·±åº¦æ¸…ç† - Unix/Linux/macOS
_clean-all-linux:
    @echo "ğŸ§¹ æ·±åº¦æ¸…ç†ï¼ˆåŒ…æ‹¬ä¾èµ–ï¼‰..."
    cd frontend && rm -rf node_modules package-lock.json

_clean-all-macos:
    @echo "ğŸ§¹ æ·±åº¦æ¸…ç†ï¼ˆåŒ…æ‹¬ä¾èµ–ï¼‰..."
    cd frontend && rm -rf node_modules package-lock.json

# æ·±åº¦æ¸…ç† - Windows
_clean-all-windows:
    @Write-Output 'ğŸ§¹ æ·±åº¦æ¸…ç†ï¼ˆåŒ…æ‹¬ä¾èµ–ï¼‰...'
    @if (Test-Path 'frontend/node_modules') { Remove-Item -Recurse -Force 'frontend/node_modules' }
    @if (Test-Path 'frontend/package-lock.json') { Remove-Item -Force 'frontend/package-lock.json' }
    @Write-Output 'âœ… æ·±åº¦æ¸…ç†å®Œæˆ'

# ===== å·¥å…· =====

# æ£€æŸ¥å‰ç½®æ¡ä»¶
check-prereqs:
    @just _check-prereqs-{{os()}}

# æ£€æŸ¥å‰ç½®æ¡ä»¶ - Unix/Linux/macOS
_check-prereqs-linux:
    #!/usr/bin/env bash
    echo "ğŸ” æ£€æŸ¥å‰ç½®æ¡ä»¶..."
    echo "å½“å‰ç³»ç»Ÿ: Linux"
    echo ""
    if command -v rustc &> /dev/null; then
        echo "âœ… Rust: $(rustc --version)"
    else
        echo "âŒ Rust æœªå®‰è£…"
        exit 1
    fi
    if command -v cargo &> /dev/null; then
        echo "âœ… Cargo: $(cargo --version)"
    else
        echo "âŒ Cargo æœªå®‰è£…"
        exit 1
    fi
    if command -v node &> /dev/null; then
        echo "âœ… Node.js: $(node --version)"
    else
        echo "âŒ Node.js æœªå®‰è£…"
        exit 1
    fi
    if command -v npm &> /dev/null; then
        echo "âœ… npm: $(npm --version)"
    else
        echo "âŒ npm æœªå®‰è£…"
        exit 1
    fi
    if command -v ccr &> /dev/null; then
        echo "âœ… CCR: $(ccr --version 2>/dev/null || echo 'installed')"
    else
        echo "âš ï¸  CCR æœªå®‰è£…ï¼ˆåç«¯è¿è¡Œæ—¶éœ€è¦ï¼‰"
    fi
    echo ""
    echo "âœ… å‰ç½®æ¡ä»¶æ£€æŸ¥å®Œæˆ"

_check-prereqs-macos:
    #!/usr/bin/env bash
    echo "ğŸ” æ£€æŸ¥å‰ç½®æ¡ä»¶..."
    echo "å½“å‰ç³»ç»Ÿ: macOS"
    echo ""
    if command -v rustc &> /dev/null; then
        echo "âœ… Rust: $(rustc --version)"
    else
        echo "âŒ Rust æœªå®‰è£…"
        exit 1
    fi
    if command -v cargo &> /dev/null; then
        echo "âœ… Cargo: $(cargo --version)"
    else
        echo "âŒ Cargo æœªå®‰è£…"
        exit 1
    fi
    if command -v node &> /dev/null; then
        echo "âœ… Node.js: $(node --version)"
    else
        echo "âŒ Node.js æœªå®‰è£…"
        exit 1
    fi
    if command -v npm &> /dev/null; then
        echo "âœ… npm: $(npm --version)"
    else
        echo "âŒ npm æœªå®‰è£…"
        exit 1
    fi
    if command -v ccr &> /dev/null; then
        echo "âœ… CCR: $(ccr --version 2>/dev/null || echo 'installed')"
    else
        echo "âš ï¸  CCR æœªå®‰è£…ï¼ˆåç«¯è¿è¡Œæ—¶éœ€è¦ï¼‰"
    fi
    echo ""
    echo "âœ… å‰ç½®æ¡ä»¶æ£€æŸ¥å®Œæˆ"

# æ£€æŸ¥å‰ç½®æ¡ä»¶ - Windows
_check-prereqs-windows:
    @Write-Output 'ğŸ” æ£€æŸ¥å‰ç½®æ¡ä»¶...'
    @Write-Output 'å½“å‰ç³»ç»Ÿ: Windows'
    @Write-Output ''
    @if (Get-Command rustc -ErrorAction SilentlyContinue) { Write-Host 'âœ… Rust:' (rustc --version) } else { Write-Host 'âŒ Rust æœªå®‰è£…' }
    @if (Get-Command cargo -ErrorAction SilentlyContinue) { Write-Host 'âœ… Cargo:' (cargo --version) } else { Write-Host 'âŒ Cargo æœªå®‰è£…' }
    @if (Get-Command node -ErrorAction SilentlyContinue) { Write-Host 'âœ… Node.js:' (node --version) } else { Write-Host 'âŒ Node.js æœªå®‰è£…' }
    @if (Get-Command npm -ErrorAction SilentlyContinue) { Write-Host 'âœ… npm:' (npm --version) } else { Write-Host 'âŒ npm æœªå®‰è£…' }
    @if (Get-Command ccr -ErrorAction SilentlyContinue) { try { Write-Host 'âœ… CCR:' (ccr --version) } catch { Write-Host 'âœ… CCR: installed' } } else { Write-Host 'âš ï¸  CCR æœªå®‰è£…ï¼ˆåç«¯è¿è¡Œæ—¶éœ€è¦ï¼‰' }
    @Write-Output ''
    @Write-Output 'âœ… å‰ç½®æ¡ä»¶æ£€æŸ¥å®Œæˆ'

# æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
info:
    @just _info-{{os()}}

# é¡¹ç›®ä¿¡æ¯ - Unix/Linux/macOS
_info-linux:
    @echo "ğŸ“Š CCR UI é¡¹ç›®ä¿¡æ¯"
    @echo "=================="
    @echo ""
    @echo "ğŸ’» å½“å‰ç³»ç»Ÿ: Linux"
    @echo ""
    @echo "ğŸ“ é¡¹ç›®ç»“æ„:"
    @echo "  - backend/  : Actix Web (Rust)"
    @echo "  - frontend/ : Next.js 16 Beta (TypeScript + Turbopack)"
    @echo "  - logs/     : æ—¥å¿—æ–‡ä»¶ï¼ˆæŒ‰æ—¥åˆ†å‰²ï¼Œä¿ç•™14å¤©ï¼‰"
    @echo ""
    @echo "ğŸŒ å¼€å‘ç«¯å£:"
    @echo "  - åç«¯: http://localhost:8081"
    @echo "  - å‰ç«¯: http://localhost:5173 (Vue 3 + Vite)"
    @echo "  - React å‰ç«¯: http://localhost:3000 (Next.js, ä½¿ç”¨ just dev-react)"
    @echo ""
    @echo "ğŸ“ æ—¥å¿—æ–‡ä»¶:"
    @echo "  - logs/backend.log  : åç«¯æ—¥å¿—ï¼ˆè‡ªåŠ¨æŒ‰æ—¥åˆ†å‰²ï¼‰"
    @echo "  - logs/frontend.log : å‰ç«¯æ—¥å¿—"
    @echo "  - just clean-logs   : æ¸…ç†14å¤©å‰çš„æ—¥å¿—"
    @echo ""
    @echo "ğŸ“¦ å¸¸ç”¨å‘½ä»¤:"
    @echo "  just install    - å®‰è£…æ‰€æœ‰ä¾èµ–"
    @echo "  just dev        - å¯åŠ¨å¼€å‘ç¯å¢ƒ"
    @echo "  just build      - æ„å»ºç”Ÿäº§ç‰ˆæœ¬"
    @echo "  just check      - æ£€æŸ¥ä»£ç "
    @echo "  just clean-logs - æ¸…ç†æ—§æ—¥å¿—"
    @echo "  just clean      - æ¸…ç†æ„å»ºäº§ç‰©"
    @echo ""
    @echo "ğŸ“š æ›´å¤šå‘½ä»¤: just --list"

_info-macos:
    @echo "ğŸ“Š CCR UI é¡¹ç›®ä¿¡æ¯"
    @echo "=================="
    @echo ""
    @echo "ğŸ’» å½“å‰ç³»ç»Ÿ: macOS"
    @echo ""
    @echo "ğŸ“ é¡¹ç›®ç»“æ„:"
    @echo "  - backend/  : Actix Web (Rust)"
    @echo "  - frontend/ : Next.js 16 Beta (TypeScript + Turbopack)"
    @echo "  - logs/     : æ—¥å¿—æ–‡ä»¶ï¼ˆæŒ‰æ—¥åˆ†å‰²ï¼Œä¿ç•™14å¤©ï¼‰"
    @echo ""
    @echo "ğŸŒ å¼€å‘ç«¯å£:"
    @echo "  - åç«¯: http://localhost:8081"
    @echo "  - å‰ç«¯: http://localhost:5173 (Vue 3 + Vite)"
    @echo "  - React å‰ç«¯: http://localhost:3000 (Next.js, ä½¿ç”¨ just dev-react)"
    @echo ""
    @echo "ğŸ“ æ—¥å¿—æ–‡ä»¶:"
    @echo "  - logs/backend.log  : åç«¯æ—¥å¿—ï¼ˆè‡ªåŠ¨æŒ‰æ—¥åˆ†å‰²ï¼‰"
    @echo "  - logs/frontend.log : å‰ç«¯æ—¥å¿—"
    @echo "  - just clean-logs   : æ¸…ç†14å¤©å‰çš„æ—¥å¿—"
    @echo ""
    @echo "ğŸ“¦ å¸¸ç”¨å‘½ä»¤:"
    @echo "  just install    - å®‰è£…æ‰€æœ‰ä¾èµ–"
    @echo "  just dev        - å¯åŠ¨å¼€å‘ç¯å¢ƒ"
    @echo "  just build      - æ„å»ºç”Ÿäº§ç‰ˆæœ¬"
    @echo "  just check      - æ£€æŸ¥ä»£ç "
    @echo "  just clean-logs - æ¸…ç†æ—§æ—¥å¿—"
    @echo "  just clean      - æ¸…ç†æ„å»ºäº§ç‰©"
    @echo ""
    @echo "ğŸ“š æ›´å¤šå‘½ä»¤: just --list"

# é¡¹ç›®ä¿¡æ¯ - Windows
_info-windows:
    @Write-Output 'ğŸ“Š CCR UI é¡¹ç›®ä¿¡æ¯'
    @Write-Output '===================='
    @Write-Output ''
    @Write-Output 'ğŸ’» å½“å‰ç³»ç»Ÿ: Windows'
    @Write-Output ''
    @Write-Output 'ğŸ“ é¡¹ç›®ç»“æ„:'
    @Write-Output '  - backend/  : Actix Web (Rust)'
    @Write-Output '  - frontend/ : Next.js 16 Beta (TypeScript + Turbopack)'
    @Write-Output '  - logs/     : æ—¥å¿—æ–‡ä»¶ï¼ˆæŒ‰æ—¥åˆ†å‰²ï¼Œä¿ç•™14å¤©ï¼‰'
    @Write-Output ''
    @Write-Output 'ğŸŒ å¼€å‘ç«¯å£:'
    @Write-Output '  - åç«¯: http://localhost:8081'
    @Write-Output '  - å‰ç«¯: http://localhost:5173 (Vue 3 + Vite)'
    @Write-Output '  - React å‰ç«¯: http://localhost:3000 (Next.js, ä½¿ç”¨ just dev-react)'
    @Write-Output ''
    @Write-Output 'ğŸ“ æ—¥å¿—æ–‡ä»¶:'
    @Write-Output '  - logs/backend.log  : åç«¯æ—¥å¿—ï¼ˆè‡ªåŠ¨æŒ‰æ—¥åˆ†å‰²ï¼‰'
    @Write-Output '  - logs/frontend.log : å‰ç«¯æ—¥å¿—'
    @Write-Output '  - just clean-logs   : æ¸…ç†14å¤©å‰çš„æ—¥å¿—'
    @Write-Output ''
    @Write-Output 'ğŸ“¦ å¸¸ç”¨å‘½ä»¤:'
    @Write-Output '  just install    - å®‰è£…æ‰€æœ‰ä¾èµ–'
    @Write-Output '  just dev        - å¯åŠ¨å¼€å‘ç¯å¢ƒ'
    @Write-Output '  just build      - æ„å»ºç”Ÿäº§ç‰ˆæœ¬'
    @Write-Output '  just check      - æ£€æŸ¥ä»£ç '
    @Write-Output '  just clean-logs - æ¸…ç†æ—§æ—¥å¿—'
    @Write-Output '  just clean      - æ¸…ç†æ„å»ºäº§ç‰©'
    @Write-Output ''
    @Write-Output 'ğŸ“š æ›´å¤šå‘½ä»¤: just --list'

# å¿«é€Ÿå¯åŠ¨ï¼ˆæ£€æŸ¥ + å®‰è£… + å¼€å‘ï¼‰
quick-start: check-prereqs install dev

# æ›´æ–°ä¾èµ–
update: update-backend update-frontend
    @echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆ"

# æ›´æ–°åç«¯ä¾èµ–
update-backend:
    @echo "â¬†ï¸  æ›´æ–°åç«¯ä¾èµ–..."
    cd backend && cargo update

# æ›´æ–°å‰ç«¯ä¾èµ–
update-frontend:
    @echo "â¬†ï¸  æ›´æ–°å‰ç«¯ä¾èµ–..."
    cd frontend && npm update

# ===== è¾…åŠ©å‘½ä»¤ =====

# æŸ¥çœ‹åç«¯æ—¥å¿—ï¼ˆéœ€è¦å…ˆå¯åŠ¨ï¼‰
logs-backend:
    @echo "ğŸ“‹ åç«¯æ—¥å¿—..."
    # è¿™é‡Œå¯ä»¥æ·»åŠ æ—¥å¿—æŸ¥çœ‹å‘½ä»¤

# æŸ¥çœ‹å‰ç«¯æ—¥å¿—ï¼ˆéœ€è¦å…ˆå¯åŠ¨ï¼‰
logs-frontend:
    @echo "ğŸ“‹ å‰ç«¯æ—¥å¿—..."
    # è¿™é‡Œå¯ä»¥æ·»åŠ æ—¥å¿—æŸ¥çœ‹å‘½ä»¤

# ç›‘è§†æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨é‡å¯åç«¯
watch-backend:
    @echo "ğŸ‘€ ç›‘è§†åç«¯æ–‡ä»¶å˜åŒ–..."
    cd backend && cargo watch -x run

# è¿è¡Œåç«¯æ€§èƒ½æµ‹è¯•
bench-backend:
    @echo "âš¡ è¿è¡Œåç«¯æ€§èƒ½æµ‹è¯•..."
    cd backend && cargo bench

# ç”Ÿæˆåç«¯æ–‡æ¡£
doc-backend:
    @echo "ğŸ“š ç”Ÿæˆåç«¯æ–‡æ¡£..."
    cd backend && cargo doc --no-deps --open

# ===== éƒ¨ç½²ç›¸å…³ =====

# å®Œæ•´çš„ CI æµç¨‹
ci: check test build
    @echo "âœ… CI æµç¨‹å®Œæˆ"

# å‡†å¤‡å‘å¸ƒ
prepare-release: clean build
    @echo "âœ… å‘å¸ƒå‡†å¤‡å®Œæˆ"
    @echo ""
    @echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶:"
    @echo "  - backend/target/release/ccr-ui-backend"
    @echo "  - frontend/dist/"

# ===== Tauri æ¡Œé¢åº”ç”¨ =====

# å¯åŠ¨ Tauri å¼€å‘æ¨¡å¼ï¼ˆæ¡Œé¢åº”ç”¨ï¼‰
tauri-dev:
    @just _tauri-dev-{{os()}}

_tauri-dev-linux:
    @echo "ğŸ–¥ï¸  å¯åŠ¨ Tauri æ¡Œé¢åº”ç”¨å¼€å‘æ¨¡å¼..."
    @echo "ğŸ“ Frontend: http://localhost:5173 (è‡ªåŠ¨åŠ è½½)"
    @echo "ğŸ“ Desktop: Tauri çª—å£å°†è‡ªåŠ¨æ‰“å¼€"
    @echo ""
    cd frontend && npm run tauri:dev

_tauri-dev-macos:
    @echo "ğŸ–¥ï¸  å¯åŠ¨ Tauri æ¡Œé¢åº”ç”¨å¼€å‘æ¨¡å¼..."
    @echo "ğŸ“ Frontend: http://localhost:5173 (è‡ªåŠ¨åŠ è½½)"
    @echo "ğŸ“ Desktop: Tauri çª—å£å°†è‡ªåŠ¨æ‰“å¼€"
    @echo ""
    cd frontend && npm run tauri:dev

_tauri-dev-windows:
    @Write-Output 'ğŸ–¥ï¸  å¯åŠ¨ Tauri æ¡Œé¢åº”ç”¨å¼€å‘æ¨¡å¼...'
    @Write-Output 'ğŸ“ Frontend: http://localhost:5173 (è‡ªåŠ¨åŠ è½½)'
    @Write-Output 'ğŸ“ Desktop: Tauri çª—å£å°†è‡ªåŠ¨æ‰“å¼€'
    @Write-Output ''
    @Set-Location frontend; npm run tauri:dev

# æ„å»º Tauri ç”Ÿäº§ç‰ˆæœ¬ï¼ˆæ¡Œé¢åº”ç”¨ï¼‰
tauri-build: _ensure-frontend-deps
    @just _tauri-build-{{os()}}

# ç¡®ä¿å‰ç«¯ä¾èµ–å·²å®‰è£…ï¼ˆå†…éƒ¨å‘½ä»¤ï¼‰
_ensure-frontend-deps:
    @just _ensure-frontend-deps-{{os()}}

_ensure-frontend-deps-linux:
    #!/usr/bin/env bash
    if [ ! -d "frontend/node_modules" ] || [ ! -d "frontend/node_modules/vue-i18n" ]; then
        echo "ğŸ“¦ æ£€æµ‹åˆ°ä¾èµ–ç¼ºå¤±ï¼Œæ­£åœ¨å®‰è£…å‰ç«¯ä¾èµ–..."
        cd frontend && npm install
        echo "âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ"
    else
        echo "âœ… å‰ç«¯ä¾èµ–å·²å°±ç»ª"
    fi

_ensure-frontend-deps-macos:
    #!/usr/bin/env bash
    if [ ! -d "frontend/node_modules" ] || [ ! -d "frontend/node_modules/vue-i18n" ]; then
        echo "ğŸ“¦ æ£€æµ‹åˆ°ä¾èµ–ç¼ºå¤±ï¼Œæ­£åœ¨å®‰è£…å‰ç«¯ä¾èµ–..."
        cd frontend && npm install
        echo "âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ"
    else
        echo "âœ… å‰ç«¯ä¾èµ–å·²å°±ç»ª"
    fi

_ensure-frontend-deps-windows:
    @if (-not (Test-Path 'frontend/node_modules') -or -not (Test-Path 'frontend/node_modules/vue-i18n')) { Write-Output 'ğŸ“¦ æ£€æµ‹åˆ°ä¾èµ–ç¼ºå¤±ï¼Œæ­£åœ¨å®‰è£…å‰ç«¯ä¾èµ–...'; Set-Location frontend; npm install; Write-Output 'âœ… å‰ç«¯ä¾èµ–å®‰è£…å®Œæˆ' } else { Write-Output 'âœ… å‰ç«¯ä¾èµ–å·²å°±ç»ª' }

_tauri-build-linux:
    @echo "ğŸ—ï¸  æ„å»º Tauri æ¡Œé¢åº”ç”¨ï¼ˆç”Ÿäº§ç‰ˆæœ¬ï¼‰..."
    cd frontend && npm run build:desktop
    @echo ""
    @echo "âœ… Tauri æ„å»ºå®Œæˆ"
    @echo "ğŸ“¦ äº§ç‰©ä½ç½®: frontend/src-tauri/target/release/bundle/"
    @echo "   - .deb (Debian/Ubuntu)"
    @echo "   - .AppImage (é€šç”¨ Linux)"

_tauri-build-macos:
    @echo "ğŸ—ï¸  æ„å»º Tauri æ¡Œé¢åº”ç”¨ï¼ˆç”Ÿäº§ç‰ˆæœ¬ï¼‰..."
    cd frontend && npm run build:desktop
    @echo ""
    @echo "ğŸ§¹ æ¸…ç†è‡ªåŠ¨æŒ‚è½½çš„ DMG..."
    @hdiutil detach "/Volumes/CCR Desktop" 2>/dev/null || true
    @echo ""
    @echo "âœ… Tauri æ„å»ºå®Œæˆ"
    @echo "ğŸ“¦ äº§ç‰©ä½ç½®: frontend/src-tauri/target/release/bundle/"
    @echo "   - .dmg (å®‰è£…é•œåƒ)"
    @echo "   - .app (åº”ç”¨ç¨‹åºåŒ…)"

_tauri-build-windows:
    @Write-Output 'ğŸ—ï¸  æ„å»º Tauri æ¡Œé¢åº”ç”¨ï¼ˆç”Ÿäº§ç‰ˆæœ¬ï¼‰...'
    @Set-Location frontend; npm run build:desktop
    @Write-Output ''
    @Write-Output 'âœ… Tauri æ„å»ºå®Œæˆ'
    @Write-Output 'ğŸ“¦ äº§ç‰©ä½ç½®: frontend/src-tauri/target/release/bundle/'
    @Write-Output '   - .msi (å®‰è£…ç¨‹åº)'
    @Write-Output '   - .exe (å¯æ‰§è¡Œæ–‡ä»¶)'

# æ„å»º Tauri è°ƒè¯•ç‰ˆæœ¬ï¼ˆæ›´å¿«ï¿½ï¿½ï¿½å¸¦è°ƒè¯•ç¬¦å·ï¼‰
tauri-build-debug:
    @just _tauri-build-debug-{{os()}}

_tauri-build-debug-linux:
    @echo "ğŸ—ï¸  æ„å»º Tauri æ¡Œé¢åº”ç”¨ï¼ˆè°ƒè¯•ç‰ˆæœ¬ï¼‰..."
    cd frontend && npm run tauri:build:debug
    @echo ""
    @echo "âœ… Tauri è°ƒè¯•ç‰ˆæœ¬æ„å»ºå®Œæˆ"
    @echo "ğŸ“¦ äº§ç‰©ä½ç½®: frontend/src-tauri/target/debug/bundle/"

_tauri-build-debug-macos:
    @echo "ğŸ—ï¸  æ„å»º Tauri æ¡Œé¢åº”ç”¨ï¼ˆè°ƒè¯•ç‰ˆæœ¬ï¼‰..."
    cd frontend && npm run tauri:build:debug
    @echo ""
    @echo "âœ… Tauri è°ƒè¯•ç‰ˆæœ¬æ„å»ºå®Œæˆ"
    @echo "ğŸ“¦ äº§ç‰©ä½ç½®: frontend/src-tauri/target/debug/bundle/"

_tauri-build-debug-windows:
    @Write-Output 'ğŸ—ï¸  æ„å»º Tauri æ¡Œé¢åº”ç”¨ï¼ˆè°ƒè¯•ç‰ˆæœ¬ï¼‰...'
    @Set-Location frontend; npm run tauri:build:debug
    @Write-Output ''
    @Write-Output 'âœ… Tauri è°ƒè¯•ç‰ˆæœ¬æ„å»ºå®Œæˆ'
    @Write-Output 'ğŸ“¦ äº§ç‰©ä½ç½®: frontend/src-tauri/target/debug/bundle/'

# æ£€æŸ¥ Tauri ç¯å¢ƒå’Œé…ç½®
tauri-check:
    @just _tauri-check-{{os()}}

_tauri-check-linux:
    @echo "ğŸ” æ£€æŸ¥ Tauri ç¯å¢ƒå’Œé…ç½®..."
    @echo ""
    cd frontend && npx tauri info

_tauri-check-macos:
    @echo "ğŸ” æ£€æŸ¥ Tauri ç¯å¢ƒå’Œé…ç½®..."
    @echo ""
    cd frontend && npx tauri info

_tauri-check-windows:
    @Write-Output 'ğŸ” æ£€æŸ¥ Tauri ç¯å¢ƒå’Œé…ç½®...'
    @Write-Output ''
    @Set-Location frontend; npx tauri info

# æ£€æŸ¥ Tauri Rust ä»£ç 
tauri-check-rust:
    @just _tauri-check-rust-{{os()}}

_tauri-check-rust-linux:
    @echo "ğŸ” æ£€æŸ¥ Tauri Rust ä»£ç ..."
    cd frontend && npm run tauri:check

_tauri-check-rust-macos:
    @echo "ğŸ” æ£€æŸ¥ Tauri Rust ä»£ç ..."
    cd frontend && npm run tauri:check

_tauri-check-rust-windows:
    @Write-Output 'ğŸ” æ£€æŸ¥ Tauri Rust ä»£ç ...'
    @Set-Location frontend; npm run tauri:check

# è¿è¡Œ Tauri Clippyï¼ˆRust linterï¼‰
tauri-clippy:
    @just _tauri-clippy-{{os()}}

_tauri-clippy-linux:
    @echo "ğŸ“ è¿è¡Œ Tauri Clippy..."
    cd frontend && npm run tauri:clippy

_tauri-clippy-macos:
    @echo "ğŸ“ è¿è¡Œ Tauri Clippy..."
    cd frontend && npm run tauri:clippy

_tauri-clippy-windows:
    @Write-Output 'ğŸ“ è¿è¡Œ Tauri Clippy...'
    @Set-Location frontend; npm run tauri:clippy

# æ ¼å¼åŒ– Tauri Rust ä»£ç 
tauri-fmt:
    @just _tauri-fmt-{{os()}}

_tauri-fmt-linux:
    @echo "ğŸ’… æ ¼å¼åŒ– Tauri Rust ä»£ç ..."
    cd frontend && npm run tauri:fmt

_tauri-fmt-macos:
    @echo "ğŸ’… æ ¼å¼åŒ– Tauri Rust ä»£ç ..."
    cd frontend && npm run tauri:fmt

_tauri-fmt-windows:
    @Write-Output 'ğŸ’… æ ¼å¼åŒ– Tauri Rust ä»£ç ...'
    @Set-Location frontend; npm run tauri:fmt

# è¿è¡Œ Tauri æµ‹è¯•
tauri-test:
    @just _tauri-test-{{os()}}

_tauri-test-linux:
    @echo "ğŸ§ª è¿è¡Œ Tauri æµ‹è¯•..."
    cd frontend && npm run tauri:test

_tauri-test-macos:
    @echo "ğŸ§ª è¿è¡Œ Tauri æµ‹è¯•..."
    cd frontend && npm run tauri:test

_tauri-test-windows:
    @Write-Output 'ğŸ§ª è¿è¡Œ Tauri æµ‹è¯•...'
    @Set-Location frontend; npm run tauri:test

# æ¸…ç† Tauri æ„å»ºäº§ç‰©
tauri-clean:
    @just _tauri-clean-{{os()}}

_tauri-clean-linux:
    @echo "ğŸ§¹ æ¸…ç† Tauri æ„å»ºäº§ç‰©..."
    cd frontend/src-tauri && cargo clean
    @echo "âœ… Tauri æ¸…ç†å®Œæˆ"

_tauri-clean-macos:
    @echo "ğŸ§¹ æ¸…ç† Tauri æ„å»ºäº§ç‰©..."
    cd frontend/src-tauri && cargo clean
    @echo "âœ… Tauri æ¸…ç†å®Œæˆ"

_tauri-clean-windows:
    @Write-Output 'ğŸ§¹ æ¸…ç† Tauri æ„å»ºäº§ç‰©...'
    @Set-Location frontend/src-tauri; cargo clean
    @Write-Output 'âœ… Tauri æ¸…ç†å®Œæˆ'

# Tauri å®Œæ•´æ£€æŸ¥ï¼ˆTypeScript + Rustï¼‰
tauri-check-all:
    @just _tauri-check-all-{{os()}}

_tauri-check-all-linux:
    @echo "ğŸ” è¿è¡Œ Tauri å®Œæ•´æ£€æŸ¥..."
    cd frontend && npm run check:all
    @echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"

_tauri-check-all-macos:
    @echo "ğŸ” è¿è¡Œ Tauri å®Œæ•´æ£€æŸ¥..."
    cd frontend && npm run check:all
    @echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"

_tauri-check-all-windows:
    @Write-Output 'ğŸ” è¿è¡Œ Tauri å®Œæ•´æ£€æŸ¥...'
    @Set-Location frontend; npm run check:all
    @Write-Output 'âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡'
